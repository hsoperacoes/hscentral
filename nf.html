<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>GERENCIAL HS - Recebimento de Nota Fiscal</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background-color: #000;
      color: #fff;
      margin: 0; padding: 0;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }

    .back-button {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #020617;
      color: #e5e7eb;
      border: 1px solid #111827;
      padding: 10px 22px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 14px;
      z-index: 2000;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }
    .back-button i { margin-right: 6px; }
    .back-button:hover {
      background-color: #111827;
      transform: translateX(-50%) translateY(-1px);
    }

    .logo-topo {
      width: 100px;
      height: auto;
      margin: 90px 0 10px;
    }

    .form-container {
      max-width: 600px; width: 95%;
      background: #1e1e1e; padding: 30px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.3); color: #fff; margin: 20px auto;
    }

    .form-container h2 { text-align: center; color: #fff; margin-bottom: 20px; }

    input, button {
      width: 100%; padding: 12px; font-size: 14px;
      border: 1px solid #444; border-radius: 4px;
      background-color: #2a2a2a; color: #fff;
    }

    button { border: none; background-color: #673ab7; cursor: pointer; font-weight: 600; margin-top: 10px; }
    button:hover { background-color: #5e35b1; }

    .hidden { display: none; }

    .logout { text-align: right; margin-bottom: 10px; }
    .logout button {
      background-color: #5f6368;
      width: auto;
      padding: 8px 16px;
      margin-top: 0;
    }

    .result { background: #111; border: 1px solid #333; padding: 12px; border-radius: 6px; }

    .history {
      margin-top: 20px;
      background: #141414;
      padding: 10px;
      border-radius: 8px;
    }

    .history ul { list-style: none; padding: 0; margin: 0; }
    .history li { padding: 6px 8px; border-bottom: 1px solid #222; cursor: pointer; }
    .history li:hover { background: #1d1d1d; }

    #loading-nf { margin-top: 10px; color: #9bdcff; font-style: italic; }
    #erro-nf2, #erro-nf { margin-top: 8px; }

    footer {
      text-align:center; font-size:14px; color:#ccc;
      background:#2c2c2c; padding:15px;
      border-radius:6px; margin: 20px auto;
      max-width: 900px; width: 100%;
    }

    /* ===================== OVERLAY RECUSA ===================== */
    #recusaOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.88);
      z-index: 99999;
      align-items: center;
      justify-content: center;
      padding: 18px;
      backdrop-filter: blur(2px);
    }
    .recusa-card {
      width: 100%;
      max-width: 880px;
      border: 1px solid #2a2a2f;
      border-radius: 18px;
      background: #0b0b0c;
      box-shadow: 0 8px 30px rgba(0,0,0,.55);
      overflow: hidden;
    }
    .recusa-topo {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 16px;
      border-bottom: 1px solid #2a2a2f;
      background: linear-gradient(180deg, #141416, #0f0f12);
    }
    .recusa-titulo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 900;
      color: #ff3b3b;
      letter-spacing: .2px;
    }
    .recusa-btn-fechar {
      border: 1px solid #2a2a2f;
      background: transparent;
      color: #fff;
      border-radius: 12px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 800;
      width: auto;
      margin-top: 0;
    }
    .recusa-btn-fechar:hover { background: rgba(255,255,255,.06); }
    .recusa-conteudo { padding: 16px; background: #0b0b0c; }
    .recusa-texto {
      white-space: pre-wrap;
      font-size: 16px;
      line-height: 1.55;
      color: #fff;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid #2a2a2f;
      background: #101012;
    }
    .recusa-rodape {
      padding: 14px 16px;
      border-top: 1px solid #2a2a2f;
      color: #b9b9c2;
      font-size: 13px;
      background: #0f0f12;
    }

    /* ===================== SCANNER FULLSCREEN (PORTRAIT) ===================== */
    #scannerOverlay {
      position: fixed;
      inset: 0;
      z-index: 100000;
      display: none;
      background: rgba(0,0,0,.92);
      align-items: center;
      justify-content: center;
      padding: 12px;
      backdrop-filter: blur(2px);
    }

    .scan-card {
      width: min(520px, 96vw);
      height: min(820px, 92vh);
      background: #0b0b0c;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .scan-top {
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(20,20,22,.95), rgba(10,10,12,.95));
    }
    .scan-title {
      display:flex; align-items:center; gap:10px;
      font-weight: 900;
      color: #e5e7eb;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .scan-title i { color: #bbf7d0; }

    .scan-actions { display:flex; gap:8px; align-items:center; }
    .scan-btn {
      width: auto !important;
      padding: 10px 12px !important;
      margin-top: 0 !important;
      border-radius: 12px !important;
      background: rgba(2,6,23,.88) !important;
      border: 1px solid rgba(255,255,255,.14) !important;
      color: #e5e7eb !important;
      font-weight: 800 !important;
      font-size: 12px !important;
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      min-height: 44px; /* iOS touch target */
    }
    .scan-btn:hover { filter: brightness(1.07); }
    .scan-btn.primary {
      background: rgba(103,58,183,.92) !important;
      border-color: rgba(103,58,183,.55) !important;
    }

    .scan-body {
      position: relative;
      flex: 1;
      padding: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .scan-frame {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 16px;
      overflow: hidden;
      border: 2px solid rgba(103,58,183,.6);
      box-shadow: 0 14px 40px rgba(103,58,183,.12);
      background: #000;
    }

    #html5-reader { width: 100%; height: 100%; }

    /* ‚úÖ n√£o corta o v√≠deo (melhora MUITO Code128) */
    #html5-reader video, #html5-reader canvas {
      width: 100% !important;
      height: 100% !important;
      object-fit: contain !important;
      background: #000;
      -webkit-transform: scaleX(1); /* iOS fix */
      transform: scaleX(1);
    }

    .scan-guide {
      position: absolute;
      left: 50%;
      top: 56%;
      transform: translate(-50%, -50%);
      width: min(92%, 520px);
      height: 22%;
      border: 2px solid rgba(187,247,208,.55);
      border-radius: 14px;
      box-shadow: 0 0 0 2000px rgba(0,0,0,.10) inset;
      pointer-events: none;
    }
    .scan-line {
      position:absolute;
      left: 8%;
      right: 8%;
      top: 50%;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(187,247,208,.95), transparent);
      box-shadow: 0 0 18px rgba(187,247,208,.35);
      pointer-events: none;
      animation: sweep 1.6s linear infinite;
    }
    @keyframes sweep {
      0% { transform: translateY(-26px); opacity: .35; }
      50% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(26px); opacity: .35; }
    }

    .scan-status {
      padding: 10px 12px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(10,10,12,.95);
      font-size: 12px;
      color: #cbd5e1;
      line-height: 1.4;
    }
    .scan-status b { color:#bbf7d0; }

    input, button { touch-action: manipulation; }
    
    /* iOS specific */
    input, select, textarea {
      font-size: 16px !important; /* Prevents iOS zoom */
    }

    /* Estilos espec√≠ficos para iOS */
    body.ios-device {
      -webkit-tap-highlight-color: transparent;
    }
    body.ios-device button,
    body.ios-device .scan-btn {
      min-height: 44px !important;
      cursor: pointer !important;
    }
    body.ios-device input[type="text"],
    body.ios-device input[type="number"] {
      font-size: 16px !important;
    }
  </style>
</head>

<body>
  <a href="index.html" class="back-button">
    <i class="fas fa-arrow-left"></i> Voltar √† Home
  </a>

  <img src="logo.png" alt="Logo HS" class="logo-topo" />

  <div class="form-container">
    <!-- LOGIN FILIAL -->
    <div id="login-nf">
      <h2>Login da Filial</h2>
      <label for="codigo-nf">C√≥digo da Filial</label>
      <input type="text" id="codigo-nf" placeholder="Digite o c√≥digo da sua filial" />
      <button id="btn-entrar-nf">Entrar</button>
      <div id="erro-nf" style="color:#ff6b6b;margin-top:8px;"></div>
    </div>

    <!-- TELA PRINCIPAL -->
    <div id="principal-nf" class="hidden">
      <div class="logout">
        <button id="btn-sair-nf">Sair</button>
      </div>

      <h2>Consulta de Nota Fiscal</h2>

      <label for="chave-nf">Chave de Acesso (44 d√≠gitos)</label>
      <input type="text" id="chave-nf" placeholder="Digite a chave completa" maxlength="44" />

      <button id="btn-leitor-nf">üì∑ Ler C√≥digo de Barras</button>

      <button id="btn-consultar-nf">Consultar</button>
      <div id="loading-nf" class="hidden">‚è≥ Consultando nota fiscal...</div>
      <div id="resultado-nf" class="result hidden"></div>
      <div id="erro-nf2" style="color: #ff6b6b; margin-top: 8px;"></div>

      <div class="history">
        <h3>Hist√≥rico da Filial</h3>
        <ul id="historicoLista-nf"></ul>
        <button id="btn-limpar-nf">üóë Limpar Hist√≥rico Local</button>
      </div>
    </div>
  </div>

  <footer>HS Opera√ß√µes ¬© 2025 - Todos os direitos reservados</footer>

  <!-- OVERLAY RECUSA -->
  <div id="recusaOverlay">
    <div class="recusa-card" role="dialog" aria-modal="true">
      <div class="recusa-topo">
        <div class="recusa-titulo">üö´ NOTA MARCADA PARA RECUSA</div>
        <button class="recusa-btn-fechar" id="btn-fechar-recusa">Fechar</button>
      </div>
      <div class="recusa-conteudo">
        <div class="recusa-texto" id="recusaTexto"></div>
      </div>
      <div class="recusa-rodape">
        Se houver confirma√ß√£o da recusa, realize tamb√©m a recusa no controle de transporte e na via f√≠sica destinada ao escrit√≥rio.
      </div>
    </div>
  </div>

  <!-- ‚úÖ SCANNER FULLSCREEN -->
  <div id="scannerOverlay">
    <div class="scan-card">
      <div class="scan-top">
        <div class="scan-title">
          <i class="fas fa-barcode"></i>
          Leitor de C√≥digo (Chave 44)
        </div>
        <div class="scan-actions">
          <button class="scan-btn" id="btn-zoom-out" title="Diminuir zoom"><i class="fas fa-search-minus"></i></button>
          <button class="scan-btn" id="btn-zoom-in" title="Aumentar zoom"><i class="fas fa-search-plus"></i></button>
          <button class="scan-btn" id="btn-torch" title="Lanterna"><i class="fas fa-bolt"></i></button>
          <button class="scan-btn primary" id="btn-fechar-scan"><i class="fas fa-times"></i> Fechar</button>
        </div>
      </div>

      <div class="scan-body">
        <div class="scan-frame">
          <div id="html5-reader"></div>
          <div class="scan-guide"></div>
          <div class="scan-line"></div>
        </div>
      </div>

      <div class="scan-status" id="scanStatus">Status: <b>pronto</b></div>
    </div>
  </div>

  <script>
    // ‚úÖ SEU APPWEB (AGORA DO JEITO QUE O script_nf.js NORMALMENTE ESPERA)
    const URL_API = "https://script.google.com/macros/s/AKfycbxu_jVaotWytMOQh4UCZetFZFOxgk5ePrOkaviDd-qKNPiu2_8BjCaNczAVZzaDwAbj/exec";
    window.URL_API = URL_API; // compat
    window.__HS_DISABLE_DYNAMSOFT__ = true;

    function abrirOverlayRecusa(mensagem) {
      const ov = document.getElementById('recusaOverlay');
      const tx = document.getElementById('recusaTexto');
      tx.textContent = (mensagem || '').toString().trim();
      ov.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
    function fecharOverlayRecusa() {
      const ov = document.getElementById('recusaOverlay');
      ov.style.display = 'none';
      document.body.style.overflow = '';
    }
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('btn-fechar-recusa');
      const ov = document.getElementById('recusaOverlay');
      btn.addEventListener('click', fecharOverlayRecusa);
      ov.addEventListener('click', (e) => { if (e.target === ov) fecharOverlayRecusa(); });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && ov.style.display === 'flex') fecharOverlayRecusa();
      });
    });

    // ‚úÖ LOGOUT FOR√áADO (pra voltar e trocar filial SEM travar)
    function logoutNF_forcado(){
      try{
        // remove s√≥ chaves do NF, sem apagar outras coisas do HS Central
        const toRemove = [];
        for(let i=0; i<localStorage.length; i++){
          const k = localStorage.key(i);
          if(!k) continue;
          const kl = k.toLowerCase();
          if(
            kl.startsWith("hs_nf") ||
            kl.startsWith("hs-nf") ||
            kl.startsWith("nf_") ||
            kl.includes("nf_filial") ||
            kl.includes("filial_nf") ||
            kl.includes("hsnf")
          ){
            toRemove.push(k);
          }
        }
        toRemove.forEach(k => localStorage.removeItem(k));
      }catch(e){}

      // volta telas
      const login = document.getElementById("login-nf");
      const principal = document.getElementById("principal-nf");
      if(login) login.classList.remove("hidden");
      if(principal) principal.classList.add("hidden");

      // limpa campos
      const chave = document.getElementById("chave-nf");
      if(chave) chave.value = "";
      const res = document.getElementById("resultado-nf");
      if(res){ res.classList.add("hidden"); res.innerHTML = ""; }
      const err = document.getElementById("erro-nf2");
      if(err) err.textContent = "";
      const err1 = document.getElementById("erro-nf");
      if(err1) err1.textContent = "";

      // garante foco
      const cod = document.getElementById("codigo-nf");
      if(cod) cod.focus();
    }
  </script>

  <!-- ‚úÖ seu sistema (login/consulta/hist√≥rico) -->
  <script src="script_nf.js?v=1.0.4"></script>

  <script>
    // ========= Scanner COMPLETO - OTIMIZADO PARA iOS =========
    let html5Scanner = null;
    let scannerOpen = false;
    let travado = false;

    let currentTrack = null;
    let zoomLevel = 1;
    let zoomMin = 1;
    let zoomMax = 1;
    let torchOn = false;
    let torchSupported = false;
    let zoomSupported = false;

    // Detectar iOS
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    // ‚úÖ DEBUG iOS
    if (isIOS) {
      console.log("üì± iOS detectado - Aplicando otimiza√ß√µes");
      console.log("User Agent:", navigator.userAgent);
      console.log("iOS Version:", navigator.userAgent.match(/OS (\d+)_/)?.[1]);
      console.log("Safari Version:", navigator.userAgent.match(/Version\/(\d+)/)?.[1]);
      console.log("MediaDevices available:", !!navigator.mediaDevices);
      console.log("getUserMedia available:", !!navigator.mediaDevices?.getUserMedia);

      // Adicionar classe iOS ao body
      document.body.classList.add('ios-device');

      // For√ßar meta tag viewport para iOS
      const viewport = document.querySelector('meta[name="viewport"]');
      if (viewport) {
        viewport.setAttribute('content',
          'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover'
        );
      }
    }

    function status_(html){
      const statusEl = document.getElementById("scanStatus");
      if(statusEl) statusEl.innerHTML = "Status: " + html;
    }

    // ‚úÖ FUN√á√ÉO CR√çTICA: Extrair chave de 44 d√≠gitos (MELHORADA)
    function extrairChave44(texto){
      console.log("üìÑ Texto recebido para extra√ß√£o:", texto);

      // Remove tudo que n√£o √© n√∫mero
      const only = String(texto || "").replace(/\D/g, "");
      console.log("üî¢ Apenas n√∫meros:", only);

      // Se n√£o tem pelo menos 44 d√≠gitos, retorna vazio
      if (only.length < 44) {
        console.log("‚ö†Ô∏è Texto com menos de 44 d√≠gitos:", only.length);
        return "";
      }

      // Procura por 44 d√≠gitos consecutivos
      for (let i = 0; i <= only.length - 44; i++) {
        const cand = only.slice(i, i + 44);
        if (/^\d{44}$/.test(cand)) {
          console.log("‚úÖ Chave encontrada:", cand.substring(0, 10) + "...");
          return cand;
        }
      }

      console.log("‚ùå Nenhuma sequ√™ncia de 44 d√≠gitos encontrada");
      return "";
    }

    function beepOk(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "square"; o.frequency.value = 880;
        g.gain.value = 0.10;
        o.connect(g); g.connect(ctx.destination);
        o.start(); setTimeout(()=>o.stop(), 120);
      }catch(e){}
      try{ if(navigator.vibrate) navigator.vibrate(60); }catch(e){}
    }

    async function applyZoom_(z){
      if(!currentTrack || !zoomSupported) return;
      try{
        await currentTrack.applyConstraints({ advanced: [{ zoom: z }] });
        zoomLevel = z;
        status_(`<b>lendo‚Ä¶</b><br/>Zoom: ${zoomLevel.toFixed(1)}x`);
      }catch(e){}
    }

    async function toggleTorch_(){
      if(!currentTrack || !torchSupported) return;
      try{
        torchOn = !torchOn;
        await currentTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
        status_(`<b>lendo‚Ä¶</b><br/>Lanterna: ${torchOn ? "ON" : "OFF"}`);
      }catch(e){}
    }

    // ‚úÖ iOS SAFE: preencher campo DEPOIS que fechar o scanner (2 frames + delay)
    function preencherCampoChaveIOSSafe(chave){
      const chaveInput = document.getElementById("chave-nf");
      if (!chaveInput) {
        console.error("‚ùå Campo chave-nf n√£o encontrado!");
        return;
      }

      const apply = () => {
        chaveInput.value = chave;
        chaveInput.setAttribute("value", chave);

        // eventos para qualquer valida√ß√£o/listener do script_nf.js
        chaveInput.dispatchEvent(new Event("input", { bubbles: true }));
        chaveInput.dispatchEvent(new Event("change", { bubbles: true }));
      };

      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          apply();
          setTimeout(() => {
            try {
              chaveInput.focus();
              if (chaveInput.setSelectionRange) {
                chaveInput.setSelectionRange(chave.length, chave.length);
              }
            } catch(e){}
          }, 80);
        });
      });
    }

    async function fecharScanner(){
      scannerOpen = false;
      travado = false;
      torchOn = false;
      currentTrack = null;
      zoomSupported = false;
      torchSupported = false;

      const ov = document.getElementById("scannerOverlay");
      if(ov) ov.style.display = "none";
      document.body.style.overflow = "";

      try{
        if(html5Scanner){
          await html5Scanner.stop().catch(()=>{});
          await html5Scanner.clear().catch(()=>{});
          html5Scanner = null;
        }

        // Liberar stream de c√¢mera
        const video = document.querySelector("#html5-reader video");
        if (video && video.srcObject) {
          const stream = video.srcObject;
          const tracks = stream.getTracks();
          tracks.forEach(track => track.stop());
          video.srcObject = null;
        }
      }catch(e){
        console.warn("Erro ao fechar scanner:", e);
      }

      status_("<b>fechado</b>");
    }

    // ‚úÖ FUN√á√ÉO CR√çTICA: Processar leitura com valida√ß√£o melhorada (iOS FIX: fecha antes e preenche depois)
    async function processarLeitura(decodedText) {
      console.log("üîç Processando leitura:", decodedText);

      if(!scannerOpen || travado) {
        console.log("‚ö†Ô∏è Scanner fechado ou travado");
        return false;
      }

      const chave = extrairChave44(decodedText);
      console.log("üîë Chave extra√≠da:", chave);

      if(!chave){
        status_(`<b>leu algo</b><br/>"${decodedText.substring(0, 20)}..."<br/>Procurando 44 d√≠gitos...`);
        return false;
      }

      // Valida se realmente tem 44 d√≠gitos
      if (chave.length !== 44 || !/^\d{44}$/.test(chave)) {
        status_(`<b style="color:#ff6b6b">Formato inv√°lido</b><br/>Encontrado: ${chave.length} d√≠gitos`);
        return false;
      }

      travado = true;

      // Mostrar que capturou
      status_(`<b style="color:#bbf7d0">‚úÖ CAPTURADO!</b><br/>Chave: ${chave.substring(0, 10)}...`);

      // Beep de confirma√ß√£o (ok ainda aberto)
      beepOk();

      // ‚úÖ iOS: fecha o scanner primeiro (Safari engole updates de input com v√≠deo ativo)
      await new Promise(resolve => setTimeout(resolve, 120));
      await fecharScanner();

      // ‚úÖ s√≥ depois preenche o campo (mais confi√°vel no Safari iOS)
      setTimeout(() => {
        console.log("üìù Preenchendo (p√≥s-fechamento) chave-nf:", chave);
        preencherCampoChaveIOSSafe(chave);
      }, 150);

      return true;
    }

    // ‚úÖ Fun√ß√£o auxiliar para mostrar erro no iOS
    function mostrarErroIOS(error) {
      let mensagem = "";

      if (error && error.name === 'NotAllowedError') {
        mensagem = `
          <b style="color:#ff6b6b">‚ùå Permiss√£o negada</b><br/>
          Para usar o scanner no iOS:<br/><br/>
          1. Toque em <b>"Permitir"</b> quando o iOS perguntar<br/>
          2. Se negou antes: Ajustes > Safari > C√¢mera > Permitir<br/>
          3. Tente novamente
        `;
      } else if (error && error.name === 'NotFoundError') {
        mensagem = `
          <b style="color:#ff6b6b">üì∑ C√¢mera n√£o encontrada</b><br/>
          Verifique se h√° uma c√¢mera dispon√≠vel.
        `;
      } else if (error && error.message && String(error.message).includes('requestDevice')) {
        mensagem = `
          <b style="color:#ff6b6b">üö´ Problema de hardware</b><br/>
          Reinicie o Safari e tente novamente.
        `;
      } else {
        mensagem = `
          <b style="color:#ff6b6b">Erro: ${(error && error.message) ? error.message : "Desconhecido"}</b><br/>
          Tente:<br/>
          1. Fechar e abrir o scanner<br/>
          2. Reiniciar o Safari<br/>
          3. Usar digita√ß√£o manual
        `;
      }

      status_(mensagem);

      setTimeout(() => {
        fecharScanner();

        // Mostrar erro tamb√©m na tela principal
        const erroDiv = document.getElementById("erro-nf2");
        if (erroDiv) {
          erroDiv.innerHTML = `<small>‚ö†Ô∏è Problema no scanner iOS. Use digita√ß√£o manual ou tente em outro dispositivo.</small>`;
        }
      }, 5000);
    }

    async function abrirScanner(){
      console.log("üöÄ Abrindo scanner...");

      const chaveInput = document.getElementById("chave-nf");

      // Verificar se j√° tem conte√∫do
      if (chaveInput && chaveInput.value.trim() !== '') {
        if (!confirm("O campo j√° cont√©m um c√≥digo. Deseja limpar e escanear um novo?")) {
          return;
        }
        chaveInput.value = "";
      }

      const ov = document.getElementById("scannerOverlay");
      if(ov) ov.style.display = "flex";
      document.body.style.overflow = "hidden";

      scannerOpen = true;
      travado = false;
      status_("<b>abrindo c√¢mera‚Ä¶</b>");

      try{
        if(html5Scanner){
          await html5Scanner.stop().catch(()=>{});
          await html5Scanner.clear().catch(()=>{});
          html5Scanner = null;
        }
      }catch(e){}

      html5Scanner = new Html5Qrcode("html5-reader");
      console.log("üì∑ Html5Qrcode instanciado");

      // ‚úÖ CONFIGURA√á√ÉO OTIMIZADA
      const config = {
        fps: isIOS ? 10 : 30, // iOS funciona melhor com FPS mais baixo
        qrbox: {
          width: isIOS ? 250 : 300,
          height: isIOS ? 150 : 200
        },
        aspectRatio: 1.0,
        disableFlip: false,
        experimentalFeatures: {
          useBarCodeDetectorIfSupported: !isIOS // Desativar apenas no iOS
        },
        rememberLastUsedCamera: true,
        formatsToSupport: [
          Html5QrcodeSupportedFormats.CODE_128,
          Html5QrcodeSupportedFormats.QR_CODE,
          Html5QrcodeSupportedFormats.EAN_13,
          Html5QrcodeSupportedFormats.EAN_8,
          Html5QrcodeSupportedFormats.UPC_A,
          Html5QrcodeSupportedFormats.UPC_E
        ]
      };

      status_("<b>procurando o c√≥digo‚Ä¶</b><br/>Aproxime e alinhe no ret√¢ngulo.");

      try {
        // ‚úÖ Callback direto e simples
        const onScanSuccess = async (decodedText, decodedResult) => {
          console.log("‚úÖ C√≥digo detectado:", decodedText);
          console.log("üìä Resultado detalhado:", decodedResult);

          // Processar imediatamente
          await processarLeitura(decodedText);
        };

        const onScanFailure = (error) => {
          // Ignorar erros normais (como "NotFoundException")
          if (error && !error.toString().includes("NotFound")) {
            console.log("Scanner error:", error);
          }
        };

        // ‚úÖ Iniciar scanner
        await html5Scanner.start(
          { facingMode: "environment" },
          config,
          onScanSuccess,
          onScanFailure
        );

        console.log("‚úÖ Scanner iniciado com sucesso!");
        status_("<b>‚úÖ Scanner pronto!</b><br/>Aponte para o c√≥digo de barras.");

      } catch (error) {
        console.error("‚ùå Erro ao iniciar scanner:", error);

        // ‚úÖ TENTATIVA ALTERNATIVA se "environment" falhar
        if (error && error.message && error.message.includes("environment")) {
          console.log("üîÑ Tentando c√¢mera frontal...");
          status_("<b>Tentando c√¢mera frontal‚Ä¶</b>");

          try {
            await html5Scanner.start(
              { facingMode: "user" }, // Tentar c√¢mera frontal
              config,
              async (decodedText) => {
                await processarLeitura(decodedText);
              }
            );
            status_("<b>‚úÖ Usando c√¢mera frontal</b><br/>Aponte para o c√≥digo.");
          } catch (error2) {
            console.error("‚ùå Erro com c√¢mera frontal:", error2);
            mostrarErroIOS(error2);
          }
        } else {
          mostrarErroIOS(error);
        }
      }
    }

    async function toggleScanner(){
      if(scannerOpen) return fecharScanner();
      return abrirScanner();
    }

    // ‚úÖ Configura√ß√£o ROBUSTA do bot√£o
    function configurarBotaoLeitor() {
      const btn = document.getElementById("btn-leitor-nf");
      if(!btn) {
        console.warn("Bot√£o btn-leitor-nf n√£o encontrado, tentando novamente...");
        setTimeout(configurarBotaoLeitor, 500);
        return;
      }

      // Remover qualquer evento anterior
      const oldBtn = btn;
      const newBtn = oldBtn.cloneNode(true);
      oldBtn.parentNode.replaceChild(newBtn, oldBtn);

      // ‚úÖ (FIX) n√£o usar passive:true (em iOS pode atrapalhar preventDefault)
      newBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();

        console.log("üì∏ Bot√£o scanner clicado!");

        // Limpar mensagens de erro anteriores
        const errorDiv = document.getElementById("erro-nf2") || document.getElementById("erro-nf");
        if(errorDiv) errorDiv.textContent = "";

        try {
          await toggleScanner();
        } catch(ex) {
          console.error("Erro no scanner:", ex);
          if(errorDiv) {
            errorDiv.textContent = "Erro: " + (ex.message || ex);
          }
          await fecharScanner();
        }
      });
      
      console.log("‚úÖ Bot√£o scanner configurado com sucesso!");
    }

    document.addEventListener("DOMContentLoaded", function(){
      console.log("üöÄ DOMContentLoaded - Iniciando configura√ß√£o...");

      // Configurar bot√£o leitor
      configurarBotaoLeitor();

      // Reconfigurar ap√≥s delays (caso script_nf.js altere o DOM)
      setTimeout(configurarBotaoLeitor, 300);
      setTimeout(configurarBotaoLeitor, 1000);
      setTimeout(configurarBotaoLeitor, 2000);

      // ‚úÖ logout funcional
      const btnSair = document.getElementById("btn-sair-nf");
      if(btnSair){
        btnSair.onclick = function(e){
          e.preventDefault();
          logoutNF_forcado();
        };
      }

      // ‚úÖ Bot√µes do scanner
      const btnFecharScan = document.getElementById("btn-fechar-scan");
      if(btnFecharScan) btnFecharScan.addEventListener('click', fecharScanner);

      const btnZoomIn = document.getElementById("btn-zoom-in");
      if(btnZoomIn) btnZoomIn.addEventListener('click', async function(){
        if(!zoomSupported) {
          status_("<b>zoom n√£o suportado</b>");
          return;
        }
        const step = 0.5;
        await applyZoom_(Math.min(zoomMax, zoomLevel + step));
      });

      const btnZoomOut = document.getElementById("btn-zoom-out");
      if(btnZoomOut) btnZoomOut.addEventListener('click', async function(){
        if(!zoomSupported) {
          status_("<b>zoom n√£o suportado</b>");
          return;
        }
        const step = 0.5;
        await applyZoom_(Math.max(zoomMin, zoomLevel - step));
      });

      const btnTorch = document.getElementById("btn-torch");
      if(btnTorch) btnTorch.addEventListener('click', async function(){
        if(!torchSupported) {
          status_("<b>lanterna n√£o suportada</b>");
          return;
        }
        await toggleTorch_();
      });

      // ‚úÖ Fechar com ESC
      document.addEventListener("keydown", function(e){
        if(e.key === "Escape" && scannerOpen) {
          fecharScanner();
        }
      });

      // ‚úÖ Fechar ao clicar fora (no overlay)
      const scannerOverlay = document.getElementById("scannerOverlay");
      if(scannerOverlay) {
        scannerOverlay.addEventListener('click', function(e) {
          if(e.target === scannerOverlay) {
            fecharScanner();
          }
        });
      }
    });

    // ‚úÖ Expor fun√ß√£o para debugging
    window.debugScanner = {
      abrir: abrirScanner,
      fechar: fecharScanner,
      status: scannerOpen,
      testarLeitura: function(texto) {
        console.log("üß™ Testando leitura manual com:", texto);
        return processarLeitura(texto);
      },
      config: function() {
        console.log("Scanner config:", {
          isIOS: isIOS,
          scannerOpen: scannerOpen,
          html5Scanner: !!html5Scanner,
          btnLeitor: document.getElementById("btn-leitor-nf"),
          campoChave: document.getElementById("chave-nf"),
          hasPermission: navigator.mediaDevices && navigator.mediaDevices.getUserMedia
        });
      }
    };
  </script>
</body>
</html>
