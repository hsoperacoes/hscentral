<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<title>GERENCIAL HS - Recebimento de Nota Fiscal</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<!-- ‚úÖ NOVO LEITOR -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
*{box-sizing:border-box}
body{
  font-family:Arial,sans-serif;
  background:#000;color:#fff;margin:0;padding:0;
  display:flex;flex-direction:column;align-items:center;min-height:100vh;
}

.back-button{
  position:fixed;top:20px;left:50%;transform:translateX(-50%);
  background:#020617;color:#e5e7eb;border:1px solid #111827;
  padding:10px 22px;border-radius:999px;text-decoration:none;
}
.back-button:hover{background:#111827}

.logo-topo{width:100px;margin:90px 0 10px}

.form-container{
  max-width:620px;width:95%;
  background:#1e1e1e;padding:30px;border-radius:8px;
  box-shadow:0 2px 10px rgba(0,0,0,.3);margin:20px auto;
}

input,button{
  width:100%;padding:12px;border-radius:4px;
  background:#2a2a2a;border:1px solid #444;color:#fff;font-size:14px;
}

button{background:#673ab7;border:none;font-weight:600}
button:hover{background:#5e35b1}

.hidden{display:none}

.history{
  margin-top:18px;background:#141414;padding:10px;border-radius:8px
}
.history li{
  padding:6px;border-bottom:1px solid #222;cursor:pointer
}

/* scanner mant√©m MESMO estilo antigo */
#scanner{
  display:none;margin-top:12px;background:#111;border-radius:8px;padding:10px
}
#reader video,#reader canvas{
  width:100%!important;border-radius:8px
}

footer{
  text-align:center;font-size:13px;color:#ccc;
  background:#2c2c2c;padding:15px;margin-top:auto;width:100%
}
</style>
</head>

<body>

<a href="index.html" class="back-button"><i class="fas fa-arrow-left"></i> Voltar √† Home</a>

<img src="logo.png" class="logo-topo"/>

<div class="form-container">

<!-- LOGIN -->
<div id="login">
  <h2>Login da Filial</h2>
  <input id="codigo" placeholder="C√≥digo da filial"/>
  <button onclick="entrar()">Entrar</button>
</div>

<!-- PRINCIPAL -->
<div id="principal" class="hidden">

  <button onclick="sair()" style="background:#5f6368;margin-bottom:10px">Sair</button>

  <h2>Consulta de Nota Fiscal</h2>

  <input id="chave" maxlength="44" placeholder="Chave de acesso 44 d√≠gitos"/>

  <button onclick="toggleScanner()">üì∑ Ler C√≥digo</button>

  <div id="scanner">
    <div id="reader"></div>
    <button style="margin-top:8px;background:#374151" onclick="trocarCamera()">Trocar c√¢mera</button>
  </div>

  <button onclick="consultar()">Consultar</button>

  <div id="resultado" style="margin-top:12px"></div>

  <div class="history">
    <h3>Hist√≥rico</h3>
    <ul id="hist"></ul>
  </div>

</div>
</div>

<footer>HS Opera√ß√µes ¬© 2025</footer>

<script>
/***************************************************
  ‚úÖ SEU APPWEB J√Å CONFIGURADO
***************************************************/
const URL_API =
"https://script.google.com/macros/s/AKfycbxu_jVaotWytMOQh4UCZetFZFOxgk5ePrOkaviDd-qKNPiu2_8BjCaNczAVZzaDwAbj/exec";


/***************************************************
  LOGIN + HIST√ìRICO (mantido)
***************************************************/
let filial="";
const LS_FILIAL="hs_nf_filial";

function entrar(){
  filial=document.getElementById("codigo").value.trim();
  if(!filial)return alert("Informe a filial");
  localStorage.setItem(LS_FILIAL,filial);
  document.getElementById("login").classList.add("hidden");
  document.getElementById("principal").classList.remove("hidden");
  renderHist();
}

function sair(){
  localStorage.removeItem(LS_FILIAL);
  location.reload();
}

function keyHist(){return "hist_"+filial}

function renderHist(){
  const ul=document.getElementById("hist");
  ul.innerHTML="";
  const arr=JSON.parse(localStorage.getItem(keyHist())||"[]");
  arr.forEach(c=>{
    const li=document.createElement("li");
    li.textContent=c;
    li.onclick=()=>document.getElementById("chave").value=c;
    ul.appendChild(li);
  });
}

function addHist(c){
  let arr=JSON.parse(localStorage.getItem(keyHist())||"[]");
  arr=arr.filter(x=>x!==c);
  arr.unshift(c);
  arr=arr.slice(0,25);
  localStorage.setItem(keyHist(),JSON.stringify(arr));
}


/***************************************************
  CONSULTA (mesma l√≥gica)
***************************************************/
async function consultar(){
  const chave=document.getElementById("chave").value.replace(/\D/g,"");
  if(chave.length!==44)return alert("Chave inv√°lida");

  const r=await fetch(`${URL_API}?chave=${chave}&filial=${filial}`);
  const j=await r.json();

  document.getElementById("resultado").innerHTML=
  `<b>NF:</b> ${j.data.numeroNF}<br>
   <b>Valor:</b> ${j.data.valorTotal}<br>
   <b>Qtd:</b> ${j.data.quantidadeTotal}`;

  addHist(chave);
  renderHist();
}


/***************************************************
  SCANNER NOVO (Html5Qrcode)
***************************************************/
let html5=null;
let cameraId=null;

async function toggleScanner(){
  if(html5)return pararScanner();
  iniciarScanner();
}

async function iniciarScanner(){
  document.getElementById("scanner").style.display="block";

  html5=new Html5Qrcode("reader");

  const cams=await Html5Qrcode.getCameras();
  cameraId=cams[0]?.id;

  await html5.start(
    {deviceId:{exact:cameraId}},
    {
      fps:25,
      qrbox:{width:350,height:180},
      experimentalFeatures:{useBarCodeDetectorIfSupported:true}
    },
    (txt)=>{
      const only=txt.replace(/\D/g,"");
      if(only.length>=44){
        document.getElementById("chave").value=only.slice(0,44);
        beep();
        pararScanner();
      }
    }
  );
}

async function pararScanner(){
  await html5.stop();
  await html5.clear();
  html5=null;
  document.getElementById("scanner").style.display="none";
}

async function trocarCamera(){
  const cams=await Html5Qrcode.getCameras();
  if(cams.length<2)return;
  const idx=cams.findIndex(c=>c.id===cameraId);
  cameraId=cams[(idx+1)%cams.length].id;
  await pararScanner();
  iniciarScanner();
}

function beep(){
  const ctx=new(window.AudioContext||window.webkitAudioContext)();
  const o=ctx.createOscillator();const g=ctx.createGain();
  o.connect(g);g.connect(ctx.destination);
  g.gain.value=.12;o.start();setTimeout(()=>o.stop(),120);
}


/***************************************************
  AUTO LOGIN
***************************************************/
window.onload=()=>{
  const f=localStorage.getItem(LS_FILIAL);
  if(f){
    filial=f;
    document.getElementById("login").classList.add("hidden");
    document.getElementById("principal").classList.remove("hidden");
    renderHist();
  }
}
</script>

</body>
</html>
