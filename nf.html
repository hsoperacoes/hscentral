<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>GERENCIAL HS - Recebimento de Nota Fiscal</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- Dynamsoft (mantido, mas agora √© opcional: se falhar, cai no Html5Qrcode) -->
  <script src="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@9.6.21/dist/dbr.js"></script>
  <!-- Fallback universal -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background-color: #000;
      color: #fff;
      margin: 0; padding: 0;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }

    /* BOT√ÉO HOME PADR√ÉO PRETO */
    .back-button {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #020617;
      color: #e5e7eb;
      border: 1px solid #111827;
      padding: 10px 22px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 14px;
      z-index: 2000;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }
    .back-button i { margin-right: 6px; }
    .back-button:hover {
      background-color: #111827;
      transform: translateX(-50%) translateY(-1px);
    }

    .logo-topo {
      width: 100px;
      height: auto;
      margin: 90px 0 10px;
    }

    .form-container {
      max-width: 600px; width: 95%;
      background: #1e1e1e; padding: 30px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.3); color: #fff; margin: 20px auto;
    }

    .form-container h2 { text-align: center; color: #fff; margin-bottom: 20px; }

    input, button {
      width: 100%; padding: 12px; font-size: 14px;
      border: 1px solid #444; border-radius: 4px;
      background-color: #2a2a2a; color: #fff;
    }

    button { border: none; background-color: #673ab7; cursor: pointer; font-weight: 600; margin-top: 10px; }
    button:hover { background-color: #5e35b1; }

    .hidden { display: none; }

    .logout { text-align: right; margin-bottom: 10px; }
    .logout button {
      background-color: #5f6368;
      width: auto;
      padding: 8px 16px;
      margin-top: 0;
    }

    .result {
      background: #111;
      border: 1px solid #333;
      padding: 12px;
      border-radius: 6px;
    }

    /* ‚úÖ evita estourar chave */
    .mono-wrap{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      overflow-wrap: anywhere;
      word-break: break-all;
      line-height: 1.35;
    }

    .history {
      margin-top: 20px;
      background: #141414;
      padding: 10px;
      border-radius: 8px;
    }
    .history ul { list-style: none; padding: 0; margin: 0; }
    .history li {
      padding: 8px 8px;
      border-bottom: 1px solid #222;
      cursor: pointer;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .history li:hover { background: #1d1d1d; }

    .hist-left{display:flex; flex-direction:column; gap:2px; min-width:0;}
    .hist-key{
      font-weight:800; color:#22c55e;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      overflow-wrap:anywhere; word-break:break-all;
    }
    .hist-sub{font-size:12px; color:#cbd5e1}
    .hist-date{font-size:11px; color:#94a3b8; white-space:nowrap}

    /* scanner embutido no card */
    #scanner {
      width: 100%;
      max-width: 520px;
      height: 320px;
      margin: 10px auto 0;
      position: relative;
      display: none;
      justify-content: center;
      align-items: center;
      background: #0b0b0c;
      border: 1px solid #333;
      border-radius: 10px;
      overflow: hidden;
    }

    #scanner .scan-topbar{
      position:absolute; left:0; right:0; top:0;
      display:flex; justify-content:space-between; align-items:center;
      padding:10px;
      background: linear-gradient(180deg, rgba(20,20,22,.95), rgba(10,10,12,.95));
      border-bottom: 1px solid rgba(255,255,255,.10);
      z-index: 5;
    }
    .scan-title{
      display:flex; align-items:center; gap:8px;
      font-weight:900; font-size:13px; color:#e5e7eb;
    }
    .scan-actions{display:flex; gap:8px;}
    .scan-btn{
      width:auto !important;
      padding:8px 10px !important;
      margin-top:0 !important;
      border-radius:10px !important;
      background: rgba(2,6,23,.88) !important;
      border: 1px solid rgba(255,255,255,.14) !important;
      color:#e5e7eb !important;
      font-weight:800 !important;
      font-size:12px !important;
      cursor:pointer;
    }
    .scan-btn.primary{
      background: rgba(103,58,183,.92) !important;
      border-color: rgba(103,58,183,.55) !important;
    }

    #scanner .scan-body{
      width:100%; height:100%;
      padding-top:52px;
      position:relative;
    }

    /* onde o fallback Html5Qrcode renderiza */
    #html5-reader{
      width:100%;
      height:100%;
    }
    #html5-reader video, #html5-reader canvas{
      width:100% !important;
      height:100% !important;
      object-fit: contain !important;
      background:#000;
    }

    .scan-guide{
      position:absolute;
      left:50%; top:58%;
      transform:translate(-50%,-50%);
      width: min(92%, 520px);
      height: 22%;
      border: 2px solid rgba(187,247,208,.55);
      border-radius: 14px;
      box-shadow: 0 0 0 2000px rgba(0,0,0,.10) inset;
      pointer-events:none;
    }

    #scanStatus{
      margin-top:8px;
      font-size:12px;
      color:#9bdcff;
      font-style: italic;
    }

    footer {
      text-align:center; font-size:14px; color:#ccc;
      background:#2c2c2c; padding:15px;
      border-radius:6px; margin: 20px auto;
      max-width: 900px; width: 100%;
    }

    /* ===================== OVERLAY RECUSA ===================== */
    #recusaOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.88);
      z-index: 99999;
      align-items: center;
      justify-content: center;
      padding: 18px;
      backdrop-filter: blur(2px);
    }

    .recusa-card {
      width: 100%;
      max-width: 880px;
      border: 1px solid #2a2a2f;
      border-radius: 18px;
      background: #0b0b0c;
      box-shadow: 0 8px 30px rgba(0,0,0,.55);
      overflow: hidden;
    }

    .recusa-topo {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 16px;
      border-bottom: 1px solid #2a2a2f;
      background: linear-gradient(180deg, #141416, #0f0f12);
    }

    .recusa-titulo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 900;
      color: #ff3b3b;
      letter-spacing: .2px;
    }

    .recusa-btn-fechar {
      border: 1px solid #2a2a2f;
      background: transparent;
      color: #fff;
      border-radius: 12px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 800;
      width: auto;
      margin-top: 0;
    }
    .recusa-btn-fechar:hover { background: rgba(255,255,255,.06); }

    .recusa-conteudo { padding: 16px; background: #0b0b0c; }

    .recusa-texto {
      white-space: pre-wrap;
      font-size: 16px;
      line-height: 1.55;
      color: #fff;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid #2a2a2f;
      background: #101012;
    }

    .recusa-rodape {
      padding: 14px 16px;
      border-top: 1px solid #2a2a2f;
      color: #b9b9c2;
      font-size: 13px;
      background: #0f0f12;
    }
  </style>
</head>

<body>

  <a href="index.html" class="back-button">
    <i class="fas fa-arrow-left"></i> Voltar √† Home
  </a>

  <img src="logo.png" alt="Logo HS" class="logo-topo" />

  <div class="form-container">

    <!-- LOGIN FILIAL -->
    <div id="login-nf">
      <h2>Login da Filial</h2>
      <label for="codigo-nf">C√≥digo da Filial</label>
      <input type="text" id="codigo-nf" placeholder="Digite o c√≥digo da sua filial" />
      <button id="btn-entrar-nf">Entrar</button>
      <div id="erro-nf" style="color:#ff6b6b;margin-top:8px;"></div>
    </div>

    <!-- TELA PRINCIPAL -->
    <div id="principal-nf" class="hidden">
      <div class="logout">
        <button id="btn-sair-nf">Sair</button>
      </div>

      <h2>Consulta de Nota Fiscal</h2>

      <label for="chave-nf">Chave de Acesso (44 d√≠gitos)</label>
      <input type="text" id="chave-nf" placeholder="Digite a chave completa" maxlength="44" />

      <button id="btn-leitor-nf">üì∑ Ler C√≥digo de Barras</button>

      <div id="scanner">
        <div class="scan-topbar">
          <div class="scan-title"><i class="fas fa-barcode"></i> Scanner (Chave 44)</div>
          <div class="scan-actions">
            <button class="scan-btn primary" id="btn-fechar-scan"><i class="fas fa-times"></i> Fechar</button>
          </div>
        </div>
        <div class="scan-body">
          <div id="html5-reader"></div>
          <div class="scan-guide"></div>
        </div>
      </div>
      <div id="scanStatus" class="hidden"></div>

      <button id="btn-consultar-nf">Consultar</button>
      <div id="loading-nf" class="hidden">‚è≥ Consultando nota fiscal...</div>
      <div id="resultado-nf" class="result hidden"></div>
      <div id="erro-nf2" style="color: #ff6b6b; margin-top: 8px;"></div>

      <div class="history">
        <h3>Hist√≥rico da Filial</h3>
        <ul id="historicoLista-nf"></ul>
        <button id="btn-limpar-nf">üóë Limpar Hist√≥rico Local</button>
      </div>
    </div>
  </div>

  <footer>HS Opera√ß√µes ¬© 2025 - Todos os direitos reservados</footer>

  <!-- OVERLAY RECUSA -->
  <div id="recusaOverlay">
    <div class="recusa-card" role="dialog" aria-modal="true">
      <div class="recusa-topo">
        <div class="recusa-titulo">üö´ NOTA MARCADA PARA RECUSA</div>
        <button class="recusa-btn-fechar" id="btn-fechar-recusa">Fechar</button>
      </div>

      <div class="recusa-conteudo">
        <div class="recusa-texto" id="recusaTexto"></div>
      </div>

      <div class="recusa-rodape">
        Se houver confirma√ß√£o da recusa, realize tamb√©m a recusa no controle de transporte e na via f√≠sica destinada ao escrit√≥rio.
      </div>
    </div>
  </div>

  <script>
    // ===================== SUA API =====================
    const URL_API = "https://script.google.com/macros/s/AKfycbxu_jVaotWytMOQh4UCZetFZFOxgk5ePrOkaviDd-qKNPiu2_8BjCaNczAVZzaDwAbj/exec";

    // ===================== STORAGE KEYS =====================
    const LS_FILIAL = "hs_nf_filial";
    const LS_HIST_PREFIX = "hs_nf_hist_"; // por filial

    // ===================== HELPERS =====================
    const $ = (id)=>document.getElementById(id);

    function setHidden(el, hidden){ if(!el) return; el.classList.toggle("hidden", !!hidden); }

    function onlyDigits(s){ return String(s||"").replace(/\D/g,""); }

    function extrairChave44(texto){
      const only = onlyDigits(texto);
      if(only.length < 44) return "";
      for(let i=0;i<=only.length-44;i++){
        const cand = only.slice(i,i+44);
        if(/^\d{44}$/.test(cand)) return cand;
      }
      return "";
    }

    function nowBR_(){
      const d = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function normalizeNumber_(val){
      if(val === null || val === undefined) return null;
      if(typeof val === "number" && isFinite(val)) return val;
      const s = String(val).trim();
      if(!s) return null;
      let t = s.replace(/[^\d.,-]/g,"");
      if(t.includes(",") && t.includes(".")){
        t = t.replace(/\./g,"").replace(",",".");
      } else if(t.includes(",") && !t.includes(".")){
        t = t.replace(",",".");
      }
      const n = Number(t);
      return isFinite(n) ? n : null;
    }

    function formatMoneyBR(v){
      const n = Number(v);
      if(!isFinite(n)) return String(v ?? "-");
      return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    }

    // busca recursiva por chaves em JSON
    function findByKey_(obj, keyNames){
      const targets = (keyNames||[]).map(k => String(k).toLowerCase());
      const seen = new Set();

      function walk(node){
        if(node === null || node === undefined) return undefined;
        if(typeof node !== "object") return undefined;
        if(seen.has(node)) return undefined;
        seen.add(node);

        for(const k of Object.keys(node)){
          if(targets.includes(k.toLowerCase())) return node[k];
        }
        for(const k of Object.keys(node)){
          const got = walk(node[k]);
          if(got !== undefined) return got;
        }
        return undefined;
      }
      return walk(obj);
    }

    function pickFirst_(obj, keyGroups){
      for(const keys of keyGroups){
        const v = findByKey_(obj, keys);
        if(v !== undefined && v !== null && String(v).trim() !== "") return v;
      }
      return undefined;
    }

    // ===================== OVERLAY RECUSA =====================
    function abrirOverlayRecusa(mensagem) {
      const ov = $('recusaOverlay');
      const tx = $('recusaTexto');
      tx.textContent = (mensagem || '').toString().trim();
      ov.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
    function fecharOverlayRecusa() {
      const ov = $('recusaOverlay');
      ov.style.display = 'none';
      document.body.style.overflow = '';
    }

    document.addEventListener('DOMContentLoaded', () => {
      $('btn-fechar-recusa').addEventListener('click', fecharOverlayRecusa);
      $('recusaOverlay').addEventListener('click', (e) => { if (e.target === $('recusaOverlay')) fecharOverlayRecusa(); });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && $('recusaOverlay').style.display === 'flex') fecharOverlayRecusa();
      });
    });

    // ===================== HIST√ìRICO =====================
    function histKey_(filial){ return LS_HIST_PREFIX + String(filial||""); }

    function loadHist_(filial){
      try{
        const raw = localStorage.getItem(histKey_(filial));
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }

    function saveHist_(filial, arr){
      try{ localStorage.setItem(histKey_(filial), JSON.stringify(arr || [])); }catch(e){}
    }

    function isChaveJaConsultada_(filial, chave){
      const arr = loadHist_(filial);
      return arr.some(x => String(x?.chave||"") === String(chave||""));
    }

    function addHist_(filial, item){
      const arr = loadHist_(filial);
      const chave = String(item?.chave || "");
      const filtered = arr.filter(x => String(x?.chave||"") !== chave);
      filtered.unshift(item);
      saveHist_(filial, filtered.slice(0, 60));
      renderHist_();
    }

    function renderHist_(){
      const filial = localStorage.getItem(LS_FILIAL) || "";
      const ul = $('historicoLista-nf');
      if(!ul) return;

      ul.innerHTML = "";
      const arr = loadHist_(filial);

      if(arr.length === 0){
        const li = document.createElement("li");
        li.style.cursor = "default";
        li.innerHTML = `<span style="color:#94a3b8">Sem hist√≥rico ainda.</span>`;
        ul.appendChild(li);
        return;
      }

      arr.forEach(item=>{
        const li = document.createElement("li");
        li.title = "Clique para colar a chave no campo";
        li.innerHTML = `
          <div class="hist-left">
            <div class="hist-key">${String(item.chave||"").slice(0,7)}... ‚Äî ${item.status || "OK"}</div>
            <div class="hist-sub">${item.valorFmt || ""} ${item.qtdFmt || ""}</div>
          </div>
          <div class="hist-date">${item.data || ""}</div>
        `;
        li.addEventListener("click", ()=>{
          $('chave-nf').value = String(item.chave||"");
          $('erro-nf2').textContent = "";
        });
        ul.appendChild(li);
      });
    }

    // ===================== LOGIN/LOGOUT =====================
    function showLogin_(){
      setHidden($('login-nf'), false);
      setHidden($('principal-nf'), true);
    }
    function showPrincipal_(){
      setHidden($('login-nf'), true);
      setHidden($('principal-nf'), false);
      renderHist_();
    }

    function logoutNF(){
      // n√£o apaga hist√≥rico, s√≥ desloga
      localStorage.removeItem(LS_FILIAL);
      $('codigo-nf').value = "";
      $('chave-nf').value = "";
      $('erro-nf').textContent = "";
      $('erro-nf2').textContent = "";
      setHidden($('resultado-nf'), true);
      $('resultado-nf').innerHTML = "";
      fecharScanner().catch(()=>{});
      showLogin_();
      $('codigo-nf').focus();
    }

    // ===================== API CALL =====================
    async function apiGet_(params){
      const u = new URL(URL_API);
      Object.keys(params||{}).forEach(k => u.searchParams.set(k, params[k]));
      u.searchParams.set("t", Date.now()); // anti-cache
      const resp = await fetch(u.toString(), { method:"GET" });
      const text = await resp.text();
      try{ return JSON.parse(text); }
      catch(e){ return { success:false, message:"Retorno n√£o-JSON do servidor", raw:text }; }
    }

    // ===================== RENDER RESULT =====================
    function renderResultadoNF(resp, filial, chave){
      const box = $('resultado-nf');
      setHidden(box, false);

      const ok = !!resp?.success;

      // base pode vir em resp.data / resp.nf / etc
      const base = resp?.data ?? resp?.nf ?? resp?.resultado ?? resp ?? {};

      // ‚úÖ tenta achar valor / qtd / valida onde estiver
      const valorRaw = pickFirst_(base, [
        ["vNF","valorTotal","valor_total","valor","total","valorNota","valor_nota","totalNF","total_nf"]
      ]);
      const qtdRaw = pickFirst_(base, [
        ["quantidadeTotal","qtdTotal","qtd_total","quantidade","qtd","totalItens","qtdItens","qtd_itens","itensTotal"]
      ]);
      const validaRaw = pickFirst_(base, [
        ["valida","valido","status","situacao","ok","isValid","valid"]
      ]);

      const valorNum = normalizeNumber_(valorRaw);
      const qtdNum = normalizeNumber_(qtdRaw);

      const valorFmt = (valorNum !== null) ? formatMoneyBR(valorNum) : "-";
      const qtdFmt = (qtdNum !== null) ? `${qtdNum}` : "-";

      // status: tenta inferir
      let statusTxt = "OK";
      if(typeof validaRaw === "string"){
        const s = validaRaw.toLowerCase();
        if(s.includes("inv") || s.includes("erro")) statusTxt = "INV√ÅLIDA";
        else if(s.includes("val")) statusTxt = "V√ÅLIDA";
      } else if(typeof validaRaw === "boolean"){
        statusTxt = validaRaw ? "V√ÅLIDA" : "INV√ÅLIDA";
      } else {
        // fallback: se success true -> OK
        statusTxt = ok ? "OK" : "ERRO";
      }

      const msg = String(resp?.message || (ok ? "OK" : "Erro"));

      box.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px">
          <div style="font-weight:900;color:${ok ? "#4ade80" : "#ff6b6b"}">
            ${ok ? "‚úÖ Consulta OK" : "‚ùå Erro na Consulta"}
          </div>
          <div style="font-size:12px;color:#94a3b8">${nowBR_()}</div>
        </div>

        <div style="color:#cbd5e1;line-height:1.6">
          <div><b>Filial:</b> ${filial || "-"}</div>
          <div><b>Status:</b> ${statusTxt}</div>
          <div><b>Chave:</b> <span class="mono-wrap">${chave || "-"}</span></div>
          <div><b>Valor total:</b> ${valorFmt}</div>
          <div><b>Quantidade total:</b> ${qtdFmt}</div>
        </div>

        <div style="margin-top:10px;color:${ok ? "#9bdcff" : "#ff6b6b"};font-size:13px">
          ${msg}
        </div>
      `;

      // overlay recusa (se vier)
      const recMsg = resp?.motivoRecusa || resp?.recusa || resp?.recusaMensagem;
      if(recMsg) abrirOverlayRecusa(recMsg);

      // salva hist√≥rico apenas se OK
      if(ok && chave){
        addHist_(filial, {
          chave,
          status: statusTxt,
          valorFmt: `Valor: ${valorFmt}`,
          qtdFmt: `Qtd: ${qtdFmt}`,
          data: nowBR_()
        });
      }
    }

    // ===================== CONSULTA (com TRAVA) =====================
    async function consultarNF(){
      const filial = localStorage.getItem(LS_FILIAL) || "";
      const chave = onlyDigits($('chave-nf').value || "");

      $('erro-nf2').textContent = "";
      setHidden($('resultado-nf'), true);
      $('resultado-nf').innerHTML = "";

      if(!filial){
        $('erro-nf2').textContent = "Filial n√£o encontrada. Fa√ßa login novamente.";
        return;
      }
      if(chave.length !== 44){
        $('erro-nf2').textContent = "A chave deve ter 44 d√≠gitos.";
        return;
      }

      // ‚úÖ TRAVA se j√° consultou antes
      if(isChaveJaConsultada_(filial, chave)){
        $('erro-nf2').textContent = "‚ö†Ô∏è Essa NF j√° foi consultada/validada anteriormente nesta filial. (TRAVADA)";
        return;
      }

      setHidden($('loading-nf'), false);

      try{
        const resp = await apiGet_({
          api: "consultarNotaFiscal",
          filial: filial,
          chave: chave
        });
        renderResultadoNF(resp, filial, chave);
      }catch(err){
        $('erro-nf2').textContent = "Erro ao consultar: " + (err?.message || err);
      }finally{
        setHidden($('loading-nf'), true);
      }
    }

    // ===================== SCANNER (Dynamsoft -> fallback Html5Qrcode) =====================
    let scannerOpen = false;
    let usingDynamsoft = false;
    let dbrScanner = null;

    let html5Scanner = null;

    function showScanStatus_(txt){
      const el = $('scanStatus');
      el.textContent = txt || "";
      setHidden(el, !txt);
    }

    function showScanner_(show){
      const sc = $('scanner');
      sc.style.display = show ? "flex" : "none";
    }

    function fillChaveFromScan_(decoded){
      const chave = extrairChave44(decoded);
      if(!chave){
        showScanStatus_("Detectei algo, mas n√£o achei 44 d√≠gitos‚Ä¶ tente aproximar mais.");
        return false;
      }
      $('chave-nf').value = chave;
      $('erro-nf2').textContent = "";

      // se j√° consultada, j√° avisa na hora
      const filial = localStorage.getItem(LS_FILIAL) || "";
      if(filial && isChaveJaConsultada_(filial, chave)){
        $('erro-nf2').textContent = "‚ö†Ô∏è Essa NF j√° foi consultada/validada anteriormente nesta filial. (TRAVADA)";
      }

      return true;
    }

    async function startDynamsoft_(){
      // Se a lib n√£o carregou, for√ßa fallback
      if(!window.Dynamsoft || !Dynamsoft.DBR) throw new Error("Dynamsoft DBR n√£o carregou");

      usingDynamsoft = true;
      showScanStatus_("Abrindo c√¢mera (Dynamsoft)‚Ä¶");

      Dynamsoft.DBR.BarcodeScanner.license = Dynamsoft.DBR.BarcodeScanner.license || ""; // n√£o mexo na sua licen√ßa

      dbrScanner = await Dynamsoft.DBR.BarcodeScanner.createInstance();
      dbrScanner.onFrameRead = ()=>{};
      dbrScanner.onUnduplicatedRead = (txt) => {
        if(!scannerOpen) return;
        const ok = fillChaveFromScan_(txt);
        if(ok) fecharScanner().catch(()=>{});
      };

      // configura pra priorizar Code128 / QR etc (chave 44 pode vir em v√°rios)
      try{
        const rs = await dbrScanner.getRuntimeSettings();
        rs.barcodeFormatIds =
          Dynamsoft.DBR.EnumBarcodeFormat.BF_QR_CODE |
          Dynamsoft.DBR.EnumBarcodeFormat.BF_CODE_128 |
          Dynamsoft.DBR.EnumBarcodeFormat.BF_EAN_13;
        rs.expectedBarcodesCount = 1;
        await dbrScanner.updateRuntimeSettings(rs);
      }catch(e){}

      // Render no nosso container
      dbrScanner.setUIElement($('html5-reader')); // reaproveita div
      await dbrScanner.open();
      showScanStatus_("Aponte a c√¢mera para a chave‚Ä¶");
    }

    async function startHtml5_(){
      usingDynamsoft = false;
      showScanStatus_("Abrindo c√¢mera (Html5Qrcode)‚Ä¶");

      // limpa qualquer UI antiga
      $('html5-reader').innerHTML = "";

      html5Scanner = new Html5Qrcode("html5-reader");

      const config = {
        fps: 30,
        qrbox: (view) => {
          const w = Math.min(view.width, 520);
          const h = Math.min(view.height, 320);
          const boxW = Math.floor(w * 0.92);
          const boxH = Math.floor(h * 0.28);
          return { width: boxW, height: boxH };
        },
        disableFlip: true,
        experimentalFeatures: { useBarCodeDetectorIfSupported: true },
        rememberLastUsedCamera: true
      };

      await html5Scanner.start(
        { facingMode: "environment" },
        config,
        (decodedText)=>{
          if(!scannerOpen) return;
          const ok = fillChaveFromScan_(decodedText);
          if(ok) fecharScanner().catch(()=>{});
        },
        ()=>{}
      );

      showScanStatus_("Aponte a c√¢mera para a chave‚Ä¶");
    }

    async function abrirScanner(){
      if(scannerOpen) return;
      scannerOpen = true;
      showScanner_(true);
      showScanStatus_("Iniciando‚Ä¶");

      // tenta dynamsoft; se falhar, fallback html5
      try{
        await startDynamsoft_();
      }catch(e){
        try{
          await startHtml5_();
        }catch(ex){
          showScanStatus_("");
          $('erro-nf2').textContent = "Erro ao abrir c√¢mera: " + (ex?.message || ex);
          await fecharScanner().catch(()=>{});
        }
      }
    }

    async function fecharScanner(){
      scannerOpen = false;
      showScanStatus_("");

      // para dynamsoft
      try{
        if(dbrScanner){
          await dbrScanner.close().catch(()=>{});
          dbrScanner.destroyContext && dbrScanner.destroyContext();
          dbrScanner = null;
        }
      }catch(e){}

      // para html5
      try{
        if(html5Scanner){
          await html5Scanner.stop().catch(()=>{});
          await html5Scanner.clear().catch(()=>{});
          html5Scanner = null;
        }
      }catch(e){}

      // limpa leitor
      try{ $('html5-reader').innerHTML = ""; }catch(e){}

      showScanner_(false);
    }

    // ===================== BINDS =====================
    document.addEventListener("DOMContentLoaded", ()=>{
      // restaura sess√£o
      const savedFilial = localStorage.getItem(LS_FILIAL);
      if(savedFilial){
        showPrincipal_();
      }else{
        showLogin_();
        $('codigo-nf').focus();
      }

      $('btn-entrar-nf').addEventListener("click", ()=>{
        const cod = onlyDigits($('codigo-nf').value || "");
        if(!cod){
          $('erro-nf').textContent = "Digite o c√≥digo da filial.";
          return;
        }
        $('erro-nf').textContent = "";
        localStorage.setItem(LS_FILIAL, cod);
        showPrincipal_();
      });

      $('btn-sair-nf').addEventListener("click", (e)=>{
        e.preventDefault();
        logoutNF();
      });

      $('btn-consultar-nf').addEventListener("click", (e)=>{
        e.preventDefault();
        consultarNF();
      });

      $('btn-leitor-nf').addEventListener("click", async (e)=>{
        e.preventDefault();
        $('erro-nf2').textContent = "";
        await abrirScanner();
      });

      $('btn-fechar-scan').addEventListener("click", (e)=>{
        e.preventDefault();
        fecharScanner().catch(()=>{});
      });

      $('btn-limpar-nf').addEventListener("click", ()=>{
        const filial = localStorage.getItem(LS_FILIAL) || "";
        if(!filial) return;
        if(!confirm("Limpar hist√≥rico local dessa filial?")) return;
        localStorage.removeItem(histKey_(filial));
        renderHist_();
      });

      $('chave-nf').addEventListener("input", ()=>{
        const filial = localStorage.getItem(LS_FILIAL) || "";
        const chave = onlyDigits($('chave-nf').value || "");
        if(filial && chave.length === 44 && isChaveJaConsultada_(filial, chave)){
          $('erro-nf2').textContent = "‚ö†Ô∏è Essa NF j√° foi consultada/validada anteriormente nesta filial. (TRAVADA)";
        } else {
          if($('erro-nf2').textContent.includes("(TRAVADA)")) $('erro-nf2').textContent = "";
        }
      });

      $('chave-nf').addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          consultarNF();
        }
      });

      // seguran√ßa: fecha scanner ao sair da p√°gina
      window.addEventListener("pagehide", ()=>{ fecharScanner().catch(()=>{}); });
    });
  </script>

</body>
</html>
