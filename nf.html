<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>GERENCIAL HS - Recebimento de Nota Fiscal</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- ‚úÖ Usar vers√£o MAIS RECENTE do html5-qrcode -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background-color: #000;
      color: #fff;
      margin: 0; padding: 0;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }

    .back-button {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #020617;
      color: #e5e7eb;
      border: 1px solid #111827;
      padding: 10px 22px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 14px;
      z-index: 2000;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }
    .back-button i { margin-right: 6px; }
    .back-button:hover {
      background-color: #111827;
      transform: translateX(-50%) translateY(-1px);
    }

    .logo-topo {
      width: 100px;
      height: auto;
      margin: 90px 0 10px;
    }

    .form-container {
      max-width: 600px; width: 95%;
      background: #1e1e1e; padding: 30px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.3); color: #fff; margin: 20px auto;
    }

    .form-container h2 { text-align: center; color: #fff; margin-bottom: 20px; }

    input, button {
      width: 100%; padding: 12px; font-size: 14px;
      border: 1px solid #444; border-radius: 4px;
      background-color: #2a2a2a; color: #fff;
    }

    button { border: none; background-color: #673ab7; cursor: pointer; font-weight: 600; margin-top: 10px; }
    button:hover { background-color: #5e35b1; }

    .hidden { display: none; }

    .logout { text-align: right; margin-bottom: 10px; }
    .logout button {
      background-color: #5f6368;
      width: auto;
      padding: 8px 16px;
      margin-top: 0;
    }

    .result { background: #111; border: 1px solid #333; padding: 12px; border-radius: 6px; }

    .history {
      margin-top: 20px;
      background: #141414;
      padding: 10px;
      border-radius: 8px;
    }

    .history ul { list-style: none; padding: 0; margin: 0; }
    .history li { padding: 6px 8px; border-bottom: 1px solid #222; cursor: pointer; }
    .history li:hover { background: #1d1d1d; }

    #loading-nf { margin-top: 10px; color: #9bdcff; font-style: italic; }
    #erro-nf2, #erro-nf { margin-top: 8px; }

    footer {
      text-align:center; font-size:14px; color:#ccc;
      background:#2c2c2c; padding:15px;
      border-radius:6px; margin: 20px auto;
      max-width: 900px; width: 100%;
    }

    /* ===================== OVERLAY RECUSA ===================== */
    #recusaOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.88);
      z-index: 99999;
      align-items: center;
      justify-content: center;
      padding: 18px;
      backdrop-filter: blur(2px);
    }
    .recusa-card {
      width: 100%;
      max-width: 880px;
      border: 1px solid #2a2a2f;
      border-radius: 18px;
      background: #0b0b0c;
      box-shadow: 0 8px 30px rgba(0,0,0,.55);
      overflow: hidden;
    }
    .recusa-topo {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 16px;
      border-bottom: 1px solid #2a2a2f;
      background: linear-gradient(180deg, #141416, #0f0f12);
    }
    .recusa-titulo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 900;
      color: #ff3b3b;
      letter-spacing: .2px;
    }
    .recusa-btn-fechar {
      border: 1px solid #2a2a2f;
      background: transparent;
      color: #fff;
      border-radius: 12px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 800;
      width: auto;
      margin-top: 0;
    }
    .recusa-btn-fechar:hover { background: rgba(255,255,255,.06); }
    .recusa-conteudo { padding: 16px; background: #0b0b0c; }
    .recusa-texto {
      white-space: pre-wrap;
      font-size: 16px;
      line-height: 1.55;
      color: #fff;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid #2a2a2f;
      background: #101012;
    }
    .recusa-rodape {
      padding: 14px 16px;
      border-top: 1px solid #2a2a2f;
      color: #b9b9c2;
      font-size: 13px;
      background: #0f0f12;
    }

    /* ===================== SCANNER SIMPLIFICADO ===================== */
    #scannerOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 100000;
      display: none;
      flex-direction: column;
    }

    .scan-header {
      background: rgba(0,0,0,0.9);
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #333;
    }

    .scan-title {
      color: white;
      font-weight: bold;
      font-size: 18px;
    }

    .scan-close {
      background: #673ab7;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }

    #reader {
      width: 100%;
      height: 100%;
      position: relative;
    }

    .scan-guide {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 200px;
      border: 2px solid #00ff00;
      border-radius: 10px;
      box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);
      z-index: 10;
      pointer-events: none;
    }

    .scan-status {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      text-align: center;
      color: white;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      font-size: 14px;
    }

    /* iOS specific */
    input, select, textarea {
      font-size: 16px !important; /* Prevents iOS zoom */
    }
  </style>
</head>

<body>
  <a href="index.html" class="back-button">
    <i class="fas fa-arrow-left"></i> Voltar √† Home
  </a>

  <img src="logo.png" alt="Logo HS" class="logo-topo" />

  <div class="form-container">
    <!-- LOGIN FILIAL -->
    <div id="login-nf">
      <h2>Login da Filial</h2>
      <label for="codigo-nf">C√≥digo da Filial</label>
      <input type="text" id="codigo-nf" placeholder="Digite o c√≥digo da sua filial" />
      <button id="btn-entrar-nf">Entrar</button>
      <div id="erro-nf" style="color:#ff6b6b;margin-top:8px;"></div>
    </div>

    <!-- TELA PRINCIPAL -->
    <div id="principal-nf" class="hidden">
      <div class="logout">
        <button id="btn-sair-nf">Sair</button>
      </div>

      <h2>Consulta de Nota Fiscal</h2>

      <label for="chave-nf">Chave de Acesso (44 d√≠gitos)</label>
      <input type="text" id="chave-nf" placeholder="Digite a chave completa" maxlength="44" />

      <button id="btn-leitor-nf">üì∑ Ler C√≥digo de Barras</button>

      <button id="btn-consultar-nf">Consultar</button>
      <div id="loading-nf" class="hidden">‚è≥ Consultando nota fiscal...</div>
      <div id="resultado-nf" class="result hidden"></div>
      <div id="erro-nf2" style="color: #ff6b6b; margin-top: 8px;"></div>

      <div class="history">
        <h3>Hist√≥rico da Filial</h3>
        <ul id="historicoLista-nf"></ul>
        <button id="btn-limpar-nf">üóë Limpar Hist√≥rico Local</button>
      </div>
    </div>
  </div>

  <footer>HS Opera√ß√µes ¬© 2025 - Todos os direitos reservados</footer>

  <!-- OVERLAY RECUSA -->
  <div id="recusaOverlay">
    <div class="recusa-card" role="dialog" aria-modal="true">
      <div class="recusa-topo">
        <div class="recusa-titulo">üö´ NOTA MARCADA PARA RECUSA</div>
        <button class="recusa-btn-fechar" id="btn-fechar-recusa">Fechar</button>
      </div>
      <div class="recusa-conteudo">
        <div class="recusa-texto" id="recusaTexto"></div>
      </div>
      <div class="recusa-rodape">
        Se houver confirma√ß√£o da recusa, realize tamb√©m a recusa no controle de transporte e na via f√≠sica destinada ao escrit√≥rio.
      </div>
    </div>
  </div>

  <!-- ‚úÖ SCANNER SIMPLIFICADO -->
  <div id="scannerOverlay">
    <div class="scan-header">
      <div class="scan-title">üì∑ Leitor de C√≥digo de Barras</div>
      <button class="scan-close" id="btn-fechar-scan">Fechar</button>
    </div>
    <div id="reader"></div>
    <div class="scan-guide"></div>
    <div class="scan-status" id="scanStatus">Aponte para o c√≥digo de barras</div>
  </div>

  <script>
    // ‚úÖ SEU APPWEB
    const URL_API = "https://script.google.com/macros/s/AKfycbxu_jVaotWytMOQh4UCZetFZFOxgk5ePrOkaviDd-qKNPiu2_8BjCaNczAVZzaDwAbj/exec";
    window.URL_API = URL_API;
    window.__HS_DISABLE_DYNAMSOFT__ = true;

    function abrirOverlayRecusa(mensagem) {
      const ov = document.getElementById('recusaOverlay');
      const tx = document.getElementById('recusaTexto');
      tx.textContent = (mensagem || '').toString().trim();
      ov.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
    
    function fecharOverlayRecusa() {
      const ov = document.getElementById('recusaOverlay');
      ov.style.display = 'none';
      document.body.style.overflow = '';
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('btn-fechar-recusa');
      const ov = document.getElementById('recusaOverlay');
      btn.addEventListener('click', fecharOverlayRecusa);
      ov.addEventListener('click', (e) => { if (e.target === ov) fecharOverlayRecusa(); });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && ov.style.display === 'flex') fecharOverlayRecusa();
      });
    });

    // ‚úÖ LOGOUT FOR√áADO
    function logoutNF_forcado(){
      try{
        const toRemove = [];
        for(let i=0; i<localStorage.length; i++){
          const k = localStorage.key(i);
          if(!k) continue;
          const kl = k.toLowerCase();
          if(
            kl.startsWith("hs_nf") ||
            kl.startsWith("hs-nf") ||
            kl.startsWith("nf_") ||
            kl.includes("nf_filial") ||
            kl.includes("filial_nf") ||
            kl.includes("hsnf")
          ){
            toRemove.push(k);
          }
        }
        toRemove.forEach(k => localStorage.removeItem(k));
      }catch(e){}

      const login = document.getElementById("login-nf");
      const principal = document.getElementById("principal-nf");
      if(login) login.classList.remove("hidden");
      if(principal) principal.classList.add("hidden");

      const chave = document.getElementById("chave-nf");
      if(chave) chave.value = "";
      const res = document.getElementById("resultado-nf");
      if(res){ res.classList.add("hidden"); res.innerHTML = ""; }
      const err = document.getElementById("erro-nf2");
      if(err) err.textContent = "";
      const err1 = document.getElementById("erro-nf");
      if(err1) err1.textContent = "";

      const cod = document.getElementById("codigo-nf");
      if(cod) cod.focus();
    }
  </script>

  <!-- ‚úÖ seu sistema (login/consulta/hist√≥rico) -->
  <script src="script_nf.js?v=1.0.4"></script>

  <script>
    // ========= SCANNER SIMPLIFICADO PARA iOS =========
    let html5QrCode = null;
    let scannerOpen = false;
    
    // Detectar iOS
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    
    console.log("üì± Sistema:", isIOS ? "iOS" : "Android/Desktop");
    
    function status_(mensagem) {
      const statusEl = document.getElementById("scanStatus");
      if(statusEl) statusEl.textContent = mensagem;
    }
    
    // ‚úÖ FUN√á√ÉO SIMPLIFICADA para extrair chave de 44 d√≠gitos
    function extrairChave44(texto) {
      if(!texto) return "";
      
      // Remove tudo que n√£o √© n√∫mero
      const numeros = texto.replace(/\D/g, "");
      
      // Procura por exatamente 44 d√≠gitos consecutivos
      if(numeros.length >= 44) {
        // Tenta encontrar 44 d√≠gitos consecutivos
        for(let i = 0; i <= numeros.length - 44; i++) {
          const candidato = numeros.substr(i, 44);
          if(/^\d{44}$/.test(candidato)) {
            return candidato;
          }
        }
      }
      
      return "";
    }
    
    // ‚úÖ FUN√á√ÉO para preencher o campo
    function preencherChave(chave) {
      const campo = document.getElementById("chave-nf");
      if(campo) {
        campo.value = chave;
        
        // Disparar eventos para garantir que outros scripts vejam a mudan√ßa
        campo.dispatchEvent(new Event('input', { bubbles: true }));
        campo.dispatchEvent(new Event('change', { bubbles: true }));
        
        // Focar no campo
        setTimeout(() => {
          campo.focus();
          campo.setSelectionRange(chave.length, chave.length);
        }, 100);
        
        return true;
      }
      return false;
    }
    
    // ‚úÖ FUN√á√ÉO para processar leitura
    function processarLeitura(textoLido) {
      console.log("üìñ Texto lido:", textoLido);
      
      const chave = extrairChave44(textoLido);
      console.log("üîë Chave extra√≠da:", chave);
      
      if(chave && chave.length === 44) {
        status_("‚úÖ C√≥digo lido com sucesso!");
        
        // Preencher o campo
        if(preencherChave(chave)) {
          // Fechar scanner ap√≥s 0.5 segundos
          setTimeout(fecharScanner, 500);
          return true;
        }
      } else {
        status_("‚ùå N√£o encontrei uma chave de 44 d√≠gitos. Tente novamente.");
        console.log("Texto n√£o cont√©m 44 d√≠gitos:", textoLido);
      }
      
      return false;
    }
    
    // ‚úÖ FUN√á√ÉO para iniciar scanner
    async function iniciarScanner() {
      if(scannerOpen) return;
      
      console.log("üöÄ Iniciando scanner...");
      
      // Limpar campo se necess√°rio
      const campoChave = document.getElementById("chave-nf");
      if(campoChave && campoChave.value.trim() !== '') {
        if(!confirm("J√° existe um c√≥digo no campo. Deseja limpar e escanear um novo?")) {
          return;
        }
        campoChave.value = "";
      }
      
      // Mostrar overlay
      const overlay = document.getElementById("scannerOverlay");
      if(overlay) overlay.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      scannerOpen = true;
      status_("üîÑ Iniciando c√¢mera...");
      
      try {
        // Criar nova inst√¢ncia
        html5QrCode = new Html5Qrcode("reader");
        
        // ‚úÖ CONFIGURA√á√ÉO SIMPLIFICADA que FUNCIONA no iOS
        const config = {
          fps: isIOS ? 10 : 30,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.0,
          disableFlip: false
        };
        
        // ‚úÖ C√¢mera a usar
        const cameraConfig = { 
          facingMode: "environment" 
        };
        
        // ‚úÖ Fun√ß√£o de sucesso
        const onSuccess = (decodedText, decodedResult) => {
          console.log(`‚úÖ Leitura bem-sucedida: ${decodedText}`);
          processarLeitura(decodedText);
        };
        
        // ‚úÖ Fun√ß√£o de erro (silenciosa)
        const onError = (error) => {
          // Ignorar erros comuns
          if(error && !error.includes("NotFoundException")) {
            console.warn("Erro no scanner:", error);
          }
        };
        
        // Iniciar scanner
        await html5QrCode.start(
          cameraConfig,
          config,
          onSuccess,
          onError
        );
        
        status_("üëÅÔ∏è Aponte a c√¢mera para o c√≥digo de barras");
        console.log("‚úÖ Scanner iniciado com sucesso!");
        
      } catch(error) {
        console.error("‚ùå Erro ao iniciar scanner:", error);
        
        // ‚úÖ TENTATIVA ALTERNATIVA com c√¢mera frontal
        if(error.message && error.message.includes("environment")) {
          console.log("üîÑ Tentando c√¢mera frontal...");
          status_("Tentando c√¢mera frontal...");
          
          try {
            await html5QrCode.start(
              { facingMode: "user" },
              config,
              onSuccess,
              onError
            );
            status_("üëÅÔ∏è Usando c√¢mera frontal - Aponte para o c√≥digo");
          } catch(error2) {
            mostrarErroScanner(error2);
          }
        } else {
          mostrarErroScanner(error);
        }
      }
    }
    
    // ‚úÖ FUN√á√ÉO para mostrar erro
    function mostrarErroScanner(error) {
      let mensagem = "Erro ao acessar a c√¢mera";
      
      if(error.name === 'NotAllowedError') {
        mensagem = "Permiss√£o da c√¢mera negada. Verifique as configura√ß√µes do navegador.";
      } else if(error.name === 'NotFoundError') {
        mensagem = "C√¢mera n√£o encontrada.";
      } else if(error.name === 'NotSupportedError') {
        mensagem = "Recurso n√£o suportado neste navegador.";
      } else if(error.name === 'NotReadableError') {
        mensagem = "C√¢mera j√° em uso por outro aplicativo.";
      }
      
      status_(`‚ùå ${mensagem}`);
      
      // Mostrar alerta
      alert(`Erro no scanner: ${mensagem}\n\nUse a digita√ß√£o manual.`);
      
      // Fechar scanner ap√≥s 3 segundos
      setTimeout(fecharScanner, 3000);
    }
    
    // ‚úÖ FUN√á√ÉO para fechar scanner
    async function fecharScanner() {
      console.log("üõë Fechando scanner...");
      
      if(html5QrCode) {
        try {
          await html5QrCode.stop();
          await html5QrCode.clear();
        } catch(error) {
          console.warn("Erro ao parar scanner:", error);
        }
        html5QrCode = null;
      }
      
      const overlay = document.getElementById("scannerOverlay");
      if(overlay) overlay.style.display = 'none';
      document.body.style.overflow = '';
      
      scannerOpen = false;
      status_("Pronto");
    }
    
    // ‚úÖ CONFIGURAR BOT√ÉO do scanner
    function configurarBotaoScanner() {
      const botao = document.getElementById("btn-leitor-nf");
      
      if(!botao) {
        console.warn("Bot√£o scanner n√£o encontrado, tentando novamente...");
        setTimeout(configurarBotaoScanner, 500);
        return;
      }
      
      // Remover event listeners antigos
      const novoBotao = botao.cloneNode(true);
      botao.parentNode.replaceChild(novoBotao, botao);
      
      // Adicionar novo listener
      novoBotao.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log("üì∏ Bot√£o scanner clicado!");
        
        // Limpar mensagens de erro
        const errorDiv = document.getElementById("erro-nf2") || document.getElementById("erro-nf");
        if(errorDiv) errorDiv.textContent = "";
        
        try {
          await iniciarScanner();
        } catch(error) {
          console.error("Erro ao abrir scanner:", error);
          alert("N√£o foi poss√≠vel abrir o scanner. Use a digita√ß√£o manual.");
        }
      });
      
      console.log("‚úÖ Bot√£o scanner configurado!");
    }
    
    // ‚úÖ INICIALIZAR quando o DOM estiver pronto
    document.addEventListener("DOMContentLoaded", function() {
      console.log("üöÄ Inicializando sistema...");
      
      // Configurar bot√£o scanner
      configurarBotaoScanner();
      
      // Configurar bot√£o fechar scanner
      const btnFechar = document.getElementById("btn-fechar-scan");
      if(btnFechar) {
        btnFechar.addEventListener('click', fecharScanner);
      }
      
      // Configurar bot√£o logout
      const btnSair = document.getElementById("btn-sair-nf");
      if(btnSair) {
        btnSair.onclick = function(e) {
          e.preventDefault();
          logoutNF_forcado();
        };
      }
      
      // Fechar com ESC
      document.addEventListener("keydown", function(e) {
        if(e.key === "Escape" && scannerOpen) {
          fecharScanner();
        }
      });
      
      // Fechar ao clicar fora (no overlay)
      const overlay = document.getElementById("scannerOverlay");
      if(overlay) {
        overlay.addEventListener('click', function(e) {
          if(e.target === overlay) {
            fecharScanner();
          }
        });
      }
      
      // Reconfigurar ap√≥s algum tempo (caso outro script altere o DOM)
      setTimeout(configurarBotaoScanner, 1000);
      setTimeout(configurarBotaoScanner, 3000);
    });
    
    // ‚úÖ EXPORTAR fun√ß√µes para debug
    window.scannerDebug = {
      abrir: iniciarScanner,
      fechar: fecharScanner,
      testar: function(texto) {
        console.log("Testando com:", texto);
        return processarLeitura(texto);
      },
      status: function() {
        return {
          aberto: scannerOpen,
          temScanner: !!html5QrCode,
          iOS: isIOS
        };
      }
    };
    
    console.log("‚úÖ Sistema de scanner carregado!");
  </script>
</body>
</html>
