<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>GERENCIAL HS - Recebimento de Nota Fiscal</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- ‚úÖ SOMENTE HTML5QRCODE -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background-color: #000;
      color: #fff;
      margin: 0; padding: 0;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }

    .back-button {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #020617;
      color: #e5e7eb;
      border: 1px solid #111827;
      padding: 10px 22px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 14px;
      z-index: 2000;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }
    .back-button i { margin-right: 6px; }
    .back-button:hover {
      background-color: #111827;
      transform: translateX(-50%) translateY(-1px);
    }

    .logo-topo {
      width: 100px;
      height: auto;
      margin: 90px 0 10px;
    }

    .form-container {
      max-width: 600px; width: 95%;
      background: #1e1e1e; padding: 30px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.3); color: #fff; margin: 20px auto;
    }

    .form-container h2 { text-align: center; color: #fff; margin-bottom: 20px; }

    input, button {
      width: 100%; padding: 12px; font-size: 14px;
      border: 1px solid #444; border-radius: 4px;
      background-color: #2a2a2a; color: #fff;
    }

    button { border: none; background-color: #673ab7; cursor: pointer; font-weight: 600; margin-top: 10px; }
    button:hover { background-color: #5e35b1; }

    .hidden { display: none; }

    .logout { text-align: right; margin-bottom: 10px; }
    .logout button {
      background-color: #5f6368;
      width: auto;
      padding: 8px 16px;
      margin-top: 0;
    }

    .result {
      background: #111;
      border: 1px solid #333;
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
      word-break: break-word;
      overflow-wrap: anywhere;
      line-height: 1.45;
    }

    .result .linha { display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .result .k { color:#cbd5e1; font-weight:700; }
    .result .v { color:#fff; font-weight:900; }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; font-weight:900; font-size:12px;
      border:1px solid rgba(255,255,255,.12);
      margin-top:10px;
      background: rgba(255,255,255,.06);
    }
    .pill.ok { border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); color:#bbf7d0; }
    .pill.bad { border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12); color:#fecaca; }

    .history {
      margin-top: 20px;
      background: #141414;
      padding: 10px;
      border-radius: 8px;
    }

    .history .top {
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:8px;
    }
    .history h3 { margin:0; font-size:14px; color:#e5e7eb; }
    .history small { color:#9ca3af; }

    .history ul { list-style: none; padding: 0; margin: 0; }
    .history li {
      padding: 8px 10px;
      border-bottom: 1px solid #222;
      cursor: pointer;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .history li:hover { background: #1d1d1d; }
    .history .nfmini { color:#e5e7eb; font-weight:800; }
    .history .datamini { color:#9ca3af; font-size:12px; }
    .history .valmini { color:#bbf7d0; font-weight:900; }

    #loading-nf { margin-top: 10px; color: #9bdcff; font-style: italic; }
    #erro-nf2, #erro-nf { margin-top: 8px; }

    footer {
      text-align:center; font-size:14px; color:#ccc;
      background:#2c2c2c; padding:15px;
      border-radius:6px; margin: 20px auto;
      max-width: 900px; width: 100%;
    }

    /* ===================== OVERLAY RECUSA ===================== */
    #recusaOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.88);
      z-index: 99999;
      align-items: center;
      justify-content: center;
      padding: 18px;
      backdrop-filter: blur(2px);
    }
    .recusa-card {
      width: 100%;
      max-width: 880px;
      border: 1px solid #2a2a2f;
      border-radius: 18px;
      background: #0b0b0c;
      box-shadow: 0 8px 30px rgba(0,0,0,.55);
      overflow: hidden;
    }
    .recusa-topo {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 16px;
      border-bottom: 1px solid #2a2a2f;
      background: linear-gradient(180deg, #141416, #0f0f12);
    }
    .recusa-titulo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 900;
      color: #ff3b3b;
      letter-spacing: .2px;
    }
    .recusa-btn-fechar {
      border: 1px solid #2a2a2f;
      background: transparent;
      color: #fff;
      border-radius: 12px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 800;
      width: auto;
      margin-top: 0;
    }
    .recusa-btn-fechar:hover { background: rgba(255,255,255,.06); }
    .recusa-conteudo { padding: 16px; background: #0b0b0c; }
    .recusa-texto {
      white-space: pre-wrap;
      font-size: 16px;
      line-height: 1.55;
      color: #fff;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid #2a2a2f;
      background: #101012;
    }
    .recusa-rodape {
      padding: 14px 16px;
      border-top: 1px solid #2a2a2f;
      color: #b9b9c2;
      font-size: 13px;
      background: #0f0f12;
    }

    /* ===================== SCANNER FULLSCREEN (PORTRAIT) ===================== */
    #scannerOverlay {
      position: fixed;
      inset: 0;
      z-index: 100000;
      display: none;
      background: rgba(0,0,0,.92);
      align-items: center;
      justify-content: center;
      padding: 12px;
      backdrop-filter: blur(2px);
    }

    .scan-card {
      width: min(520px, 96vw);
      height: min(820px, 92vh);
      background: #0b0b0c;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .scan-top {
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(20,20,22,.95), rgba(10,10,12,.95));
    }
    .scan-title {
      display:flex; align-items:center; gap:10px;
      font-weight: 900;
      color: #e5e7eb;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .scan-title i { color: #bbf7d0; }

    .scan-actions { display:flex; gap:8px; align-items:center; }
    .scan-btn {
      width: auto !important;
      padding: 10px 12px !important;
      margin-top: 0 !important;
      border-radius: 12px !important;
      background: rgba(2,6,23,.88) !important;
      border: 1px solid rgba(255,255,255,.14) !important;
      color: #e5e7eb !important;
      font-weight: 800 !important;
      font-size: 12px !important;
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .scan-btn:hover { filter: brightness(1.07); }
    .scan-btn.primary {
      background: rgba(103,58,183,.92) !important;
      border-color: rgba(103,58,183,.55) !important;
    }

    .scan-body {
      position: relative;
      flex: 1;
      padding: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .scan-frame {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 16px;
      overflow: hidden;
      border: 2px solid rgba(103,58,183,.6);
      box-shadow: 0 14px 40px rgba(103,58,183,.12);
      background: #000;
    }

    #html5-reader { width: 100%; height: 100%; }

    /* ‚úÖ n√£o corta o v√≠deo (melhora MUITO Code128) */
    #html5-reader video, #html5-reader canvas {
      width: 100% !important;
      height: 100% !important;
      object-fit: contain !important;
      background: #000;
    }

    .scan-guide {
      position: absolute;
      left: 50%;
      top: 56%;
      transform: translate(-50%, -50%);
      width: min(92%, 520px);
      height: 22%;
      border: 2px solid rgba(187,247,208,.55);
      border-radius: 14px;
      box-shadow: 0 0 0 2000px rgba(0,0,0,.10) inset;
      pointer-events: none;
    }
    .scan-line {
      position:absolute;
      left: 8%;
      right: 8%;
      top: 50%;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(187,247,208,.95), transparent);
      box-shadow: 0 0 18px rgba(187,247,208,.35);
      pointer-events: none;
      animation: sweep 1.6s linear infinite;
    }
    @keyframes sweep {
      0% { transform: translateY(-26px); opacity: .35; }
      50% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(26px); opacity: .35; }
    }

    .scan-status {
      padding: 10px 12px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(10,10,12,.95);
      font-size: 12px;
      color: #cbd5e1;
      line-height: 1.4;
    }
    .scan-status b { color:#bbf7d0; }

    input, button { touch-action: manipulation; }
  </style>
</head>

<body>
  <a href="index.html" class="back-button">
    <i class="fas fa-arrow-left"></i> Voltar √† Home
  </a>

  <img src="logo.png" alt="Logo HS" class="logo-topo" />

  <div class="form-container">
    <!-- LOGIN FILIAL -->
    <div id="login-nf">
      <h2>Login da Filial</h2>
      <label for="codigo-nf">C√≥digo da Filial</label>
      <input type="text" id="codigo-nf" placeholder="Digite o c√≥digo da sua filial" />
      <button id="btn-entrar-nf">Entrar</button>
      <div id="erro-nf" style="color:#ff6b6b;margin-top:8px;"></div>
    </div>

    <!-- TELA PRINCIPAL -->
    <div id="principal-nf" class="hidden">
      <div class="logout">
        <button id="btn-sair-nf">Sair</button>
      </div>

      <h2>Consulta de Nota Fiscal</h2>

      <label for="chave-nf">Chave de Acesso (44 d√≠gitos)</label>
      <input type="text" id="chave-nf" placeholder="Digite a chave completa" maxlength="44" inputmode="numeric" />

      <button id="btn-leitor-nf">üì∑ Ler C√≥digo de Barras</button>

      <button id="btn-consultar-nf">Consultar</button>
      <div id="loading-nf" class="hidden">‚è≥ Consultando nota fiscal...</div>
      <div id="resultado-nf" class="result hidden"></div>
      <div id="erro-nf2" style="color: #ff6b6b; margin-top: 8px;"></div>

      <div class="history">
        <div class="top">
          <h3>Hist√≥rico da Filial</h3>
          <small id="hist-info">‚Äî</small>
        </div>
        <ul id="historicoLista-nf"></ul>
        <button id="btn-limpar-nf">üóë Limpar Hist√≥rico Local</button>
      </div>
    </div>
  </div>

  <footer>HS Opera√ß√µes ¬© 2025 - Todos os direitos reservados</footer>

  <!-- OVERLAY RECUSA (mantido) -->
  <div id="recusaOverlay">
    <div class="recusa-card" role="dialog" aria-modal="true">
      <div class="recusa-topo">
        <div class="recusa-titulo">üö´ NOTA MARCADA PARA RECUSA</div>
        <button class="recusa-btn-fechar" id="btn-fechar-recusa">Fechar</button>
      </div>
      <div class="recusa-conteudo">
        <div class="recusa-texto" id="recusaTexto"></div>
      </div>
      <div class="recusa-rodape">
        Se houver confirma√ß√£o da recusa, realize tamb√©m a recusa no controle de transporte e na via f√≠sica destinada ao escrit√≥rio.
      </div>
    </div>
  </div>

  <!-- ‚úÖ SCANNER FULLSCREEN (Html5Qrcode) -->
  <div id="scannerOverlay">
    <div class="scan-card">
      <div class="scan-top">
        <div class="scan-title">
          <i class="fas fa-barcode"></i>
          Leitor de C√≥digo (Chave 44)
        </div>
        <div class="scan-actions">
          <button class="scan-btn" id="btn-zoom-out" title="Diminuir zoom"><i class="fas fa-search-minus"></i></button>
          <button class="scan-btn" id="btn-zoom-in" title="Aumentar zoom"><i class="fas fa-search-plus"></i></button>
          <button class="scan-btn" id="btn-torch" title="Lanterna"><i class="fas fa-bolt"></i></button>
          <button class="scan-btn primary" id="btn-fechar-scan"><i class="fas fa-times"></i> Fechar</button>
        </div>
      </div>

      <div class="scan-body">
        <div class="scan-frame">
          <div id="html5-reader"></div>
          <div class="scan-guide"></div>
          <div class="scan-line"></div>
        </div>
      </div>

      <div class="scan-status" id="scanStatus">Status: <b>pronto</b></div>
    </div>
  </div>

  <script>
    // ‚úÖ SEU APPWEB (N√ÉO ALTERAR)
    const URL_API = "https://script.google.com/macros/s/AKfycbxu_jVaotWytMOQh4UCZetFZFOxgk5ePrOkaviDd-qKNPiu2_8BjCaNczAVZzaDwAbj/exec";

    const FILIAIS_VALIDAS = ["293","488","287","288","761"];

    // ====== Estado ======
    let filialAtual = "";
    let scannerOpen = false;
    let travadoScan = false;

    let html5Scanner = null;

    let currentTrack = null;
    let zoomLevel = 1;
    let zoomMin = 1;
    let zoomMax = 1;
    let torchOn = false;
    let torchSupported = false;
    let zoomSupported = false;

    // ====== Recusa overlay (mantido) ======
    function abrirOverlayRecusa(mensagem) {
      const ov = document.getElementById('recusaOverlay');
      const tx = document.getElementById('recusaTexto');
      tx.textContent = (mensagem || '').toString().trim();
      ov.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
    function fecharOverlayRecusa() {
      const ov = document.getElementById('recusaOverlay');
      ov.style.display = 'none';
      document.body.style.overflow = '';
    }

    // ====== Helpers ======
    function status_(html){
      document.getElementById("scanStatus").innerHTML = "Status: " + html;
    }

    function extrairChave44(texto){
      const only = String(texto || "").replace(/\D/g, "");
      if (only.length < 44) return "";
      for (let i=0; i<=only.length-44; i++){
        const cand = only.slice(i, i+44);
        if (/^\d{44}$/.test(cand)) return cand;
      }
      return "";
    }

    function beepOk(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "square"; o.frequency.value = 880;
        g.gain.value = 0.10;
        o.connect(g); g.connect(ctx.destination);
        o.start(); setTimeout(()=>o.stop(), 120);
      }catch(e){}
      try{ if(navigator.vibrate) navigator.vibrate(60); }catch(e){}
    }

    function keyHist_(filial){
      return `HS_NF_HIST_${String(filial||"").trim()}`;
    }

    function getHist_(filial){
      try{
        const raw = localStorage.getItem(keyHist_(filial));
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }

    function setHist_(filial, arr){
      try{
        localStorage.setItem(keyHist_(filial), JSON.stringify(arr || []));
      }catch(e){}
    }

    function addHist_(filial, item){
      const arr = getHist_(filial);
      // dedup por chave
      const chave = String(item?.chave||"").trim();
      const sem = arr.filter(x => String(x?.chave||"").trim() !== chave);
      sem.unshift(item);
      setHist_(filial, sem.slice(0, 30));
    }

    function formatLinhaResultado_(chave, data){
      const numeroNF = data?.numeroNF ?? "-";
      const valorTotal = data?.valorTotal ?? "R$ 0,00";
      const quantidadeTotal = data?.quantidadeTotal ?? "0";
      const status = String(data?.status || "").toUpperCase();

      const pillClass = (status === "V√ÅLIDA") ? "pill ok" : "pill bad";
      const pillIcon = (status === "V√ÅLIDA") ? "fa-check-circle" : "fa-triangle-exclamation";

      return `
        <div class="linha"><span class="k">Chave</span><span class="v" style="font-family:monospace; font-weight:900; word-break:break-all; overflow-wrap:anywhere;">${chave}</span></div>
        <hr style="border:0;border-top:1px solid rgba(255,255,255,.10); margin:10px 0;">
        <div class="linha"><span class="k">NF</span><span class="v">${numeroNF}</span></div>
        <div class="linha"><span class="k">Valor total</span><span class="v">${valorTotal}</span></div>
        <div class="linha"><span class="k">Qtd. itens</span><span class="v">${quantidadeTotal}</span></div>
        <div class="${pillClass}"><i class="fas ${pillIcon}"></i> ${status || "‚Äî"}</div>
      `;
    }

    function setResultadoHTML_(html){
      const box = document.getElementById("resultado-nf");
      box.innerHTML = html || "";
      box.classList.remove("hidden");
    }

    function setErro_(msg){
      document.getElementById("erro-nf2").textContent = msg || "";
    }

    function setErroLogin_(msg){
      document.getElementById("erro-nf").textContent = msg || "";
    }

    function setLoading_(on){
      const el = document.getElementById("loading-nf");
      if(on) el.classList.remove("hidden");
      else el.classList.add("hidden");
    }

    function renderHistorico_(){
      const ul = document.getElementById("historicoLista-nf");
      const info = document.getElementById("hist-info");
      ul.innerHTML = "";

      const arr = getHist_(filialAtual);
      info.textContent = arr.length ? `${arr.length} itens` : "vazio";

      arr.forEach(item=>{
        const li = document.createElement("li");

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.flexDirection = "column";
        left.style.gap = "2px";

        const nf = document.createElement("div");
        nf.className = "nfmini";
        nf.textContent = `NF ${item?.data?.numeroNF ?? "-"}`;

        const dt = document.createElement("div");
        dt.className = "datamini";
        dt.textContent = item?.data?.dataRegistro ? String(item.data.dataRegistro) : "";

        left.appendChild(nf);
        left.appendChild(dt);

        const right = document.createElement("div");
        right.className = "valmini";
        right.textContent = item?.data?.valorTotal ?? "";

        li.appendChild(left);
        li.appendChild(right);

        li.addEventListener("click", ()=>{
          const chave = String(item?.chave||"").trim();
          document.getElementById("chave-nf").value = chave;
          setResultadoHTML_(formatLinhaResultado_(chave, item?.data));
          setErro_("");
        });

        ul.appendChild(li);
      });
    }

    function logout_(){
      filialAtual = "";
      try{
        localStorage.removeItem("HS_NF_FILIAL");
      }catch(e){}

      // fecha scanner se estiver aberto
      fecharScanner().catch(()=>{});

      // telas
      document.getElementById("login-nf").classList.remove("hidden");
      document.getElementById("principal-nf").classList.add("hidden");

      // limpa UI
      document.getElementById("codigo-nf").value = "";
      document.getElementById("chave-nf").value = "";
      document.getElementById("resultado-nf").classList.add("hidden");
      document.getElementById("resultado-nf").innerHTML = "";
      setErro_("");
      setErroLogin_("");
      setLoading_(false);

      document.getElementById("codigo-nf").focus();
    }

    // ====== Consulta (GS) ======
    async function consultarNF_(chave){
      const t0 = Date.now();
      const url = `${URL_API}?chave=${encodeURIComponent(chave)}&filial=${encodeURIComponent(filialAtual)}&t=${t0}`;
      const resp = await fetch(url, { method: "GET", cache: "no-store" });
      return await resp.json();
    }

    async function handleConsultarClick_(force){
      setErro_("");
      const chaveRaw = document.getElementById("chave-nf").value || "";
      const chave = String(chaveRaw).replace(/\D/g,"").trim();

      if(!FILIAIS_VALIDAS.includes(filialAtual)){
        setErro_("Filial inv√°lida. Fa√ßa login novamente.");
        return;
      }

      if(chave.length !== 44){
        setErro_("Chave deve conter exatamente 44 d√≠gitos.");
        return;
      }

      // ‚úÖ trava ‚Äúj√° consultada‚Äù por filial (local)
      const hist = getHist_(filialAtual);
      const ja = hist.find(x => String(x?.chave||"").trim() === chave);
      if(ja && !force){
        const ok = confirm("Essa chave j√° foi consultada anteriormente nessa filial.\n\nDeseja consultar novamente mesmo assim?");
        if(!ok){
          // mostra o dado salvo
          setResultadoHTML_(formatLinhaResultado_(chave, ja?.data));
          return;
        }
      }

      setLoading_(true);

      try{
        const json = await consultarNF_(chave);

        if(!json || !json.success){
          const msg = json?.message || "Erro ao consultar.";
          setErro_(msg);
          setResultadoHTML_("");
          document.getElementById("resultado-nf").classList.add("hidden");
          return;
        }

        const data = json.data || {};
        setResultadoHTML_(formatLinhaResultado_(chave, data));

        // salva hist√≥rico local SEM apagar
        addHist_(filialAtual, { chave, data, ts: Date.now() });
        renderHistorico_();
      }catch(e){
        setErro_("Falha de rede ao consultar. Tente novamente.");
      }finally{
        setLoading_(false);
      }
    }

    // ====== Scanner ======
    async function applyZoom_(z){
      if(!currentTrack || !zoomSupported) return;
      try{
        await currentTrack.applyConstraints({ advanced: [{ zoom: z }] });
        zoomLevel = z;
        status_(`<b>lendo‚Ä¶</b><br/>Zoom: ${zoomLevel.toFixed(1)}x`);
      }catch(e){}
    }

    async function toggleTorch_(){
      if(!currentTrack || !torchSupported) return;
      try{
        torchOn = !torchOn;
        await currentTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
        status_(`<b>lendo‚Ä¶</b><br/>Lanterna: ${torchOn ? "ON" : "OFF"}`);
      }catch(e){}
    }

    async function fecharScanner(){
      scannerOpen = false;
      travadoScan = false;
      torchOn = false;
      currentTrack = null;
      zoomSupported = false;
      torchSupported = false;

      const ov = document.getElementById("scannerOverlay");
      ov.style.display = "none";
      document.body.style.overflow = "";

      try{
        if(html5Scanner){
          await html5Scanner.stop().catch(()=>{});
          await html5Scanner.clear().catch(()=>{});
          html5Scanner = null;
        }
      }catch(e){}

      status_("<b>fechado</b>");
    }

    async function abrirScanner(){
      // iOS: precisa ser por clique do usu√°rio (isso aqui √© chamado pelo bot√£o)
      const ov = document.getElementById("scannerOverlay");
      ov.style.display = "flex";
      document.body.style.overflow = "hidden";

      scannerOpen = true;
      travadoScan = false;
      status_("<b>abrindo c√¢mera‚Ä¶</b>");

      try{
        if(html5Scanner){
          await html5Scanner.stop().catch(()=>{});
          await html5Scanner.clear().catch(()=>{});
          html5Scanner = null;
        }
      }catch(e){}

      html5Scanner = new Html5Qrcode("html5-reader");

      let formats = undefined;
      try{
        if(window.Html5QrcodeSupportedFormats){
          formats = [
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.QR_CODE,
            Html5QrcodeSupportedFormats.EAN_13
          ];
        }
      }catch(e){}

      const config = {
        fps: 30,
        qrbox: (view) => {
          const w = Math.min(view.width, 520);
          const h = Math.min(view.height, 820);
          const boxW = Math.floor(w * 0.92);
          const boxH = Math.floor(h * 0.22);
          return { width: boxW, height: boxH };
        },
        aspectRatio: 0.75,
        disableFlip: true,
        experimentalFeatures: { useBarCodeDetectorIfSupported: true },
        rememberLastUsedCamera: true,
        ...(formats ? { formatsToSupport: formats } : {})
      };

      const constraints = { facingMode: "environment" };

      status_("<b>procurando o c√≥digo‚Ä¶</b><br/>Aproxime e alinhe no ret√¢ngulo.");

      await html5Scanner.start(
        constraints,
        config,
        async (decodedText) => {
          if(!scannerOpen) return;
          if(travadoScan) return;

          const chave = extrairChave44(decodedText);
          if(!chave){
            status_("<b>lendo‚Ä¶</b><br/>Detectei algo, procurando 44 d√≠gitos‚Ä¶");
            return;
          }

          travadoScan = true;
          document.getElementById("chave-nf").value = chave;
          status_("<b>capturado!</b><br/>Chave 44 preenchida ‚úÖ");
          beepOk();

          await new Promise(r => setTimeout(r, 180));
          await fecharScanner();
        },
        () => {}
      );

      // tenta aplicar zoom/lanterna (quando suportado)
      setTimeout(async ()=>{
        try{
          const video = document.querySelector("#html5-reader video");
          const stream = video && video.srcObject;
          if(!stream) return;
          const t = stream.getVideoTracks && stream.getVideoTracks()[0];
          if(!t) return;

          currentTrack = t;
          const caps = currentTrack.getCapabilities ? currentTrack.getCapabilities() : {};

          if(caps.zoom){
            zoomSupported = true;
            zoomMin = caps.zoom.min;
            zoomMax = caps.zoom.max;
            zoomLevel = Math.min(Math.max(1.6, zoomMin), zoomMax);
            await applyZoom_(zoomLevel);
          } else {
            zoomSupported = false;
          }

          if(caps.torch !== undefined){
            torchSupported = true;
          } else {
            torchSupported = false;
          }
        }catch(e){}
      }, 350);
    }

    // ====== Bindings ======
    document.addEventListener("DOMContentLoaded", ()=>{
      // recusa overlay close
      document.getElementById('btn-fechar-recusa').addEventListener('click', fecharOverlayRecusa);
      document.getElementById('recusaOverlay').addEventListener('click', (e)=>{
        if(e.target.id === "recusaOverlay") fecharOverlayRecusa();
      });
      document.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape' && document.getElementById('recusaOverlay').style.display === 'flex') fecharOverlayRecusa();
      });

      // login
      document.getElementById("btn-entrar-nf").addEventListener("click", ()=>{
        setErroLogin_("");
        const f = String(document.getElementById("codigo-nf").value||"").trim();
        if(!FILIAIS_VALIDAS.includes(f)){
          setErroLogin_("C√≥digo de filial inv√°lido.");
          return;
        }
        filialAtual = f;
        try{ localStorage.setItem("HS_NF_FILIAL", filialAtual); }catch(e){}

        document.getElementById("login-nf").classList.add("hidden");
        document.getElementById("principal-nf").classList.remove("hidden");

        document.getElementById("chave-nf").focus();
        renderHistorico_();
      });

      // restore login
      try{
        const saved = localStorage.getItem("HS_NF_FILIAL");
        if(saved && FILIAIS_VALIDAS.includes(saved)){
          filialAtual = saved;
          document.getElementById("login-nf").classList.add("hidden");
          document.getElementById("principal-nf").classList.remove("hidden");
          renderHistorico_();
        }
      }catch(e){}

      // sair
      document.getElementById("btn-sair-nf").addEventListener("click", (e)=>{
        e.preventDefault();
        logout_();
      }, true);

      // consultar
      document.getElementById("btn-consultar-nf").addEventListener("click", (e)=>{
        e.preventDefault();
        handleConsultarClick_(false);
      });

      // enter no campo
      document.getElementById("chave-nf").addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          handleConsultarClick_(false);
        }
      });

      // limpar hist√≥rico local (apenas da filial atual)
      document.getElementById("btn-limpar-nf").addEventListener("click", ()=>{
        if(!filialAtual) return;
        if(!confirm("Limpar o hist√≥rico local dessa filial?")) return;
        setHist_(filialAtual, []);
        renderHistorico_();
      });

      // scanner open
      document.getElementById("btn-leitor-nf").addEventListener("click", async (e)=>{
        e.preventDefault();
        setErro_("");
        try{
          await abrirScanner();
        }catch(ex){
          setErro_("Erro ao abrir c√¢mera. Confirme permiss√£o e tente novamente.");
          await fecharScanner().catch(()=>{});
        }
      }, true);

      // scanner controls
      document.getElementById("btn-fechar-scan").addEventListener("click", (e)=>{
        e.preventDefault();
        fecharScanner();
      });

      document.addEventListener("keydown", (e)=>{
        if(e.key === "Escape" && scannerOpen) fecharScanner();
      });

      document.getElementById("btn-zoom-in").addEventListener("click", async ()=>{
        if(!zoomSupported) return status_("<b>zoom n√£o suportado</b>");
        await applyZoom_(Math.min(zoomMax, zoomLevel + 0.5));
      });

      document.getElementById("btn-zoom-out").addEventListener("click", async ()=>{
        if(!zoomSupported) return status_("<b>zoom n√£o suportado</b>");
        await applyZoom_(Math.max(zoomMin, zoomLevel - 0.5));
      });

      document.getElementById("btn-torch").addEventListener("click", async ()=>{
        if(!torchSupported) return status_("<b>lanterna n√£o suportada</b>");
        await toggleTorch_();
      });
    });
  </script>
</body>
</html>
