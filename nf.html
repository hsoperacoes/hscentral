/*************************************************
 * GERENCIAL HS - Recebimento de Nota Fiscal
 * ✅ Scanner: Html5Qrcode (substitui Dynamsoft)
 * ✅ Login filial + histórico local
 * ✅ Consulta NF + overlay recusa (se API retornar)
 *************************************************/

const APP_NF_VERSION = "2.0.0";

// ✅ TROQUE AQUI PELO SEU WEB APP (Apps Script)
const URL_API = "https://script.google.com/macros/s/AKfycbxu_jVaotWytMOQh4UCZetFZFOxgk5ePrOkaviDd-qKNPiu2_8BjCaNczAVZzaDwAbj/exec";

// ===== elementos =====
const elLogin = document.getElementById("login-nf");
const elPrincipal = document.getElementById("principal-nf");

const inpCodigo = document.getElementById("codigo-nf");
const btnEntrar = document.getElementById("btn-entrar-nf");
const btnSair = document.getElementById("btn-sair-nf");
const erroLogin = document.getElementById("erro-nf");

const inpChave = document.getElementById("chave-nf");
const btnLeitor = document.getElementById("btn-leitor-nf");
const btnConsultar = document.getElementById("btn-consultar-nf");

const elScanner = document.getElementById("scanner");
const elScannerView = document.getElementById("scanner-view");
const elScannerHint = document.getElementById("scanner-hint");
const btnFecharScanner = document.getElementById("btn-fechar-scanner");

const elLoading = document.getElementById("loading-nf");
const elResultado = document.getElementById("resultado-nf");
const elErro2 = document.getElementById("erro-nf2");

const listaHistorico = document.getElementById("historicoLista-nf");
const btnLimparHist = document.getElementById("btn-limpar-nf");

// ===== estado =====
let filialAtual = "";
let html5 = null;
let travadoLeitura = false;

// ===== storage keys =====
const LS_FILIAL = "hs_nf_filial";
const LS_HIST_PREFIX = "hs_nf_hist_"; // + filial

// ===== helpers =====
function onlyDigits(s){ return String(s || "").replace(/\D/g, ""); }

function extrairChave44(texto){
  const only = onlyDigits(texto);
  if (only.length < 44) return "";
  for (let i=0; i<=only.length-44; i++){
    const cand = only.slice(i, i+44);
    if (/^\d{44}$/.test(cand)) return cand;
  }
  return "";
}

function setHidden(el, hidden){
  if(!el) return;
  el.classList.toggle("hidden", !!hidden);
}

function setScannerVisible(on){
  elScanner.style.display = on ? "flex" : "none";
}

function beepOk(){
  try{
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "square";
    o.frequency.value = 880;
    g.gain.value = 0.08;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 110);
  }catch(e){}
  try{ if(navigator.vibrate) navigator.vibrate(50); }catch(e){}
}

function getHistKey_(){ return LS_HIST_PREFIX + (filialAtual || ""); }

function loadHistorico_(){
  const key = getHistKey_();
  try{
    const arr = JSON.parse(localStorage.getItem(key) || "[]");
    return Array.isArray(arr) ? arr : [];
  }catch(e){
    return [];
  }
}

function saveHistorico_(arr){
  const key = getHistKey_();
  localStorage.setItem(key, JSON.stringify(arr || []));
}

function addHistorico_(chave){
  const ch = onlyDigits(chave);
  if(ch.length !== 44) return;

  const hist = loadHistorico_();
  const novo = [ch, ...hist.filter(x => x !== ch)].slice(0, 30);
  saveHistorico_(novo);
  renderHistorico_();
}

function renderHistorico_(){
  const hist = loadHistorico_();
  listaHistorico.innerHTML = "";

  if(hist.length === 0){
    const li = document.createElement("li");
    li.textContent = "Sem histórico ainda.";
    li.style.color = "#9aa0a6";
    li.style.cursor = "default";
    listaHistorico.appendChild(li);
    return;
  }

  hist.forEach(ch => {
    const li = document.createElement("li");
    li.textContent = ch;
    li.title = "Clique para usar esta chave";
    li.addEventListener("click", () => {
      inpChave.value = ch;
      inpChave.focus();
    });
    listaHistorico.appendChild(li);
  });
}

function showResult_(html){
  elResultado.innerHTML = html || "";
  setHidden(elResultado, false);
}

function clearResult_(){
  setHidden(elResultado, true);
  elResultado.innerHTML = "";
}

async function apiGet_(params){
  const qs = new URLSearchParams(params || {});
  qs.set("v", APP_NF_VERSION);
  qs.set("t", Date.now().toString());
  const url = `${URL_API}?${qs.toString()}`;
  const resp = await fetch(url);
  return await resp.json();
}

// ===== login =====
function entrar_(){
  const f = (inpCodigo.value || "").trim();
  erroLogin.textContent = "";

  if(!f){
    erroLogin.textContent = "Digite o código da filial.";
    return;
  }

  filialAtual = f;
  localStorage.setItem(LS_FILIAL, f);

  setHidden(elLogin, true);
  setHidden(elPrincipal, false);

  renderHistorico_();
}

function sair_(){
  if(!confirm("Deseja sair?")) return;
  pararScanner_();
  localStorage.removeItem(LS_FILIAL);
  location.reload();
}

// ===== scanner (Html5Qrcode) =====
async function iniciarScanner_(){
  if(!window.Html5Qrcode){
    alert("Biblioteca do scanner não carregou.");
    return;
  }

  // se já existe, para
  await pararScanner_();

  // preparar view
  elScannerView.innerHTML = `<div id="html5-nf44" style="width:100%;"></div>`;
  elScannerHint.textContent = "Aponte para o código de barras da NF. Ao ler, fecha automaticamente.";

  setScannerVisible(true);
  travadoLeitura = false;

  html5 = new Html5Qrcode("html5-nf44");

  const config = {
    fps: 14,
    qrbox: { width: 320, height: 220 },
    experimentalFeatures: { useBarCodeDetectorIfSupported: true },
    rememberLastUsedCamera: true
  };

  try{
    await html5.start(
      { facingMode: "environment" },
      config,
      async (decodedText) => {
        if(travadoLeitura) return;

        const chave = extrairChave44(decodedText);
        if(!chave) return;

        travadoLeitura = true;

        inpChave.value = chave;
        beepOk();

        // fecha automático
        await new Promise(r => setTimeout(r, 120));
        await pararScanner_();
      },
      () => {}
    );
  }catch(e){
    console.error(e);
    alert("Não consegui iniciar a câmera. Verifique permissão do navegador.");
    setScannerVisible(false);
  }
}

async function pararScanner_(){
  try{
    if(html5){
      await html5.stop().catch(()=>{});
      await html5.clear().catch(()=>{});
      html5 = null;
    }
  }catch(e){}
  setScannerVisible(false);
  elScannerView.innerHTML = "";
  travadoLeitura = false;
}

function fecharScannerClick_(){
  pararScanner_();
}

// ===== consulta NF =====
async function consultar_(){
  elErro2.textContent = "";
  clearResult_();

  const chave = onlyDigits(inpChave.value);
  if(chave.length !== 44){
    elErro2.textContent = "A chave deve ter 44 dígitos.";
    return;
  }
  if(!URL_API || URL_API === "COLE_AQUI_SUA_URL_DO_APPS_SCRIPT"){
    elErro2.textContent = "URL_API não configurada no script_nf.js.";
    return;
  }

  setHidden(elLoading, false);

  try{
    // ✅ aqui você mantém o mesmo contrato que seu backend já usava
    // Ajuste o nome do api/params se no seu GAS for diferente.
    const data = await apiGet_({
      api: "consultarNotaFiscal",
      filial: filialAtual,
      chave: chave
    });

    if(!data || data.success === false){
      throw new Error(data?.message || "Falha ao consultar a nota.");
    }

    addHistorico_(chave);

    // ✅ se backend marcar recusa
    if(data.recusa === true && typeof abrirOverlayRecusa === "function"){
      abrirOverlayRecusa(data.motivoRecusa || data.mensagemRecusa || "Nota marcada para recusa.");
    }

    // ✅ render básico (ajusta pro seu retorno real se quiser)
    // Se seu backend retorna: { numeroNF, valorTotal, quantidadeTotal, emitente, ... }
    const numero = data.numeroNF ?? data.nf ?? "—";
    const valor  = data.valorTotal ?? data.vNF ?? "—";
    const qtd    = data.quantidadeTotal ?? data.qtdTotal ?? "—";
    const emit   = data.emitente ?? data.nomeEmitente ?? "—";

    showResult_(`
      <div style="display:flex;flex-direction:column;gap:10px">
        <div><b>Número NF:</b> ${numero}</div>
        <div><b>Emitente:</b> ${emit}</div>
        <div><b>Quantidade total:</b> ${qtd}</div>
        <div><b>Valor total:</b> ${valor}</div>
      </div>
    `);

  }catch(err){
    elErro2.textContent = err.message || String(err);
  }finally{
    setHidden(elLoading, true);
  }
}

// ===== binds =====
document.addEventListener("DOMContentLoaded", () => {
  // restaura filial
  const f = localStorage.getItem(LS_FILIAL);
  if(f){
    filialAtual = f;
    setHidden(elLogin, true);
    setHidden(elPrincipal, false);
    renderHistorico_();
  }

  btnEntrar.addEventListener("click", entrar_);
  btnSair.addEventListener("click", sair_);

  btnLeitor.addEventListener("click", iniciarScanner_);
  btnFecharScanner.addEventListener("click", fecharScannerClick_);

  btnConsultar.addEventListener("click", consultar_);

  btnLimparHist.addEventListener("click", () => {
    if(!confirm("Limpar histórico local desta filial?")) return;
    saveHistorico_([]);
    renderHistorico_();
  });

  // Enter no campo chave = consultar
  inpChave.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      consultar_();
    }
  });

  // Enter no login = entrar
  inpCodigo.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      entrar_();
    }
  });
});
