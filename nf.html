<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GERENCIAL HS - Recebimento de Nota Fiscal</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- ‚úÖ Html5Qrcode (substitui Dynamsoft) -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background-color: #000;
      color: #fff;
      margin: 0; padding: 0;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }

    /* BOT√ÉO HOME PADR√ÉO PRETO */
    .back-button {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #020617;
      color: #e5e7eb;
      border: 1px solid #111827;
      padding: 10px 22px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 14px;
      z-index: 2000;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }
    .back-button i { margin-right: 6px; }
    .back-button:hover {
      background-color: #111827;
      transform: translateX(-50%) translateY(-1px);
    }

    .logo-topo {
      width: 100px;
      height: auto;
      margin: 90px 0 10px;
    }

    .form-container {
      max-width: 600px; width: 95%;
      background: #1e1e1e; padding: 30px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.3); color: #fff; margin: 20px auto;
    }

    .form-container h2 { text-align: center; color: #fff; margin-bottom: 20px; }

    input, button {
      width: 100%; padding: 12px; font-size: 14px;
      border: 1px solid #444; border-radius: 4px;
      background-color: #2a2a2a; color: #fff;
    }

    button { border: none; background-color: #673ab7; cursor: pointer; font-weight: 600; margin-top: 10px; }
    button:hover { background-color: #5e35b1; }

    .hidden { display: none; }

    .logout { text-align: right; margin-bottom: 10px; }
    .logout button {
      background-color: #5f6368;
      width: auto;
      padding: 8px 16px;
    }

    .result { background: #111; border: 1px solid #333; padding: 12px; border-radius: 6px; }

    .history {
      margin-top: 20px;
      background: #141414;
      padding: 10px;
      border-radius: 8px;
    }

    .history ul { list-style: none; padding: 0; margin: 0; }
    .history li { padding: 6px 8px; border-bottom: 1px solid #222; cursor: pointer; word-break: break-all; }
    .history li:hover { background: #1d1d1d; }

    /* ‚úÖ Scanner (mesma √°rea do layout original) */
    #scanner {
      width: 100%; max-width: 420px;
      margin: 10px auto;
      position: relative;
      display: none;
      justify-content: center; align-items: center;
      background: #111;
      border: 1px solid #333;
      border-radius: 8px;
      overflow: hidden;
      padding: 10px;
    }
    #scanner-view {
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
    }
    #scanner video, #scanner canvas {
      width: 100% !important;
      height: auto !important;
      border-radius: 8px;
    }
    .scanner-hint{
      margin-top: 8px;
      font-size: 13px;
      color:#cbd5e1;
      background: rgba(31,41,55,.55);
      border: 1px solid #374151;
      padding: 10px 12px;
      border-radius: 8px;
      line-height: 1.35;
    }

    footer {
      text-align:center; font-size:14px; color:#ccc;
      background:#2c2c2c; padding:15px;
      border-radius:6px; margin: 20px auto;
      max-width: 900px; width: 100%;
    }

    /* ===================== OVERLAY RECUSA ===================== */
    #recusaOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.88);
      z-index: 99999;
      align-items: center;
      justify-content: center;
      padding: 18px;
      backdrop-filter: blur(2px);
    }

    .recusa-card {
      width: 100%;
      max-width: 880px;
      border: 1px solid #2a2a2f;
      border-radius: 18px;
      background: #0b0b0c;
      box-shadow: 0 8px 30px rgba(0,0,0,.55);
      overflow: hidden;
    }

    .recusa-topo {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 16px;
      border-bottom: 1px solid #2a2a2f;
      background: linear-gradient(180deg, #141416, #0f0f12);
    }

    .recusa-titulo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 900;
      color: #ff3b3b;
      letter-spacing: .2px;
    }

    .recusa-btn-fechar {
      border: 1px solid #2a2a2f;
      background: transparent;
      color: #fff;
      border-radius: 12px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 800;
    }
    .recusa-btn-fechar:hover { background: rgba(255,255,255,.06); }

    .recusa-conteudo { padding: 16px; background: #0b0b0c; }

    .recusa-texto {
      white-space: pre-wrap;
      font-size: 16px;
      line-height: 1.55;
      color: #fff;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid #2a2a2f;
      background: #101012;
    }

    .recusa-rodape {
      padding: 14px 16px;
      border-top: 1px solid #2a2a2f;
      color: #b9b9c2;
      font-size: 13px;
      background: #0f0f12;
    }
  </style>
</head>

<body>

  <a href="index.html" class="back-button">
    <i class="fas fa-arrow-left"></i> Voltar √† Home
  </a>

  <img src="logo.png" alt="Logo HS" class="logo-topo" />

  <div class="form-container">

    <!-- LOGIN FILIAL -->
    <div id="login-nf">
      <h2>Login da Filial</h2>
      <label for="codigo-nf">C√≥digo da Filial</label>
      <input type="text" id="codigo-nf" placeholder="Digite o c√≥digo da sua filial" />
      <button id="btn-entrar-nf">Entrar</button>
      <div id="erro-nf" style="color:#ff6b6b;margin-top:8px;"></div>
    </div>

    <!-- TELA PRINCIPAL -->
    <div id="principal-nf" class="hidden">
      <div class="logout">
        <button id="btn-sair-nf">Sair</button>
      </div>

      <h2>Consulta de Nota Fiscal</h2>

      <label for="chave-nf">Chave de Acesso (44 d√≠gitos)</label>
      <input type="text" id="chave-nf" placeholder="Digite a chave completa" maxlength="44" />

      <button id="btn-leitor-nf">üì∑ Ler C√≥digo de Barras</button>

      <!-- ‚úÖ Scanner Html5Qrcode -->
      <div id="scanner">
        <div id="scanner-view"></div>
        <div class="scanner-hint">
          Aponte para o c√≥digo de barras da NF.<br/>
          Ao detectar a chave <b>44 d√≠gitos</b>, ele preenche e fecha automaticamente.
        </div>
      </div>

      <button id="btn-consultar-nf">Consultar</button>
      <div id="loading-nf" class="hidden">‚è≥ Consultando nota fiscal...</div>
      <div id="resultado-nf" class="result hidden"></div>
      <div id="erro-nf2" style="color: #ff6b6b; margin-top: 8px;"></div>

      <div class="history">
        <h3>Hist√≥rico da Filial</h3>
        <ul id="historicoLista-nf"></ul>
        <button id="btn-limpar-nf">üóë Limpar Hist√≥rico Local</button>
      </div>
    </div>
  </div>

  <footer>HS Opera√ß√µes ¬© 2025 - Todos os direitos reservados</footer>

  <!-- OVERLAY RECUSA -->
  <div id="recusaOverlay">
    <div class="recusa-card" role="dialog" aria-modal="true">
      <div class="recusa-topo">
        <div class="recusa-titulo">üö´ NOTA MARCADA PARA RECUSA</div>
        <button class="recusa-btn-fechar" id="btn-fechar-recusa">Fechar</button>
      </div>

      <div class="recusa-conteudo">
        <div class="recusa-texto" id="recusaTexto"></div>
      </div>

      <div class="recusa-rodape">
        Se houver confirma√ß√£o da recusa, realize tamb√©m a recusa no controle de transporte e na via f√≠sica destinada ao escrit√≥rio.
      </div>
    </div>
  </div>

  <script>
    /*******************************************************
     * GERENCIAL HS - Recebimento de Nota Fiscal (INLINE)
     * ‚úÖ Scanner: Html5Qrcode (substitui Dynamsoft)
     * ‚úÖ Login filial + hist√≥rico local
     * ‚úÖ Consulta NF + overlay recusa (se API retornar)
     *******************************************************/

    // ‚úÖ COLE AQUI O SEU APPWEB (o seu estava no arquivo que voc√™ mandou)
    const URL_API = "COLE_AQUI_A_URL_DO_SEU_APPWEB";

    // Se teu backend usar outro nome de API, muda aqui:
    const API_CONSULTA = "consultarNotaFiscal";

    // ===== helpers =====
    function onlyDigits(s){ return String(s||"").replace(/\D/g,""); }

    function setHidden(el, hidden){
      if(!el) return;
      el.classList.toggle("hidden", !!hidden);
    }

    function extrairChave44(texto){
      const only = onlyDigits(texto);
      if(only.length < 44) return "";
      for(let i=0; i<=only.length-44; i++){
        const cand = only.slice(i, i+44);
        if(/^\d{44}$/.test(cand)) return cand;
      }
      return "";
    }

    let audioCtx = null;
    function beepOk(){
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = "square";
        o.frequency.value = 880;
        g.gain.value = 0.08;
        o.connect(g); g.connect(audioCtx.destination);
        o.start();
        setTimeout(()=>o.stop(), 110);
      }catch(e){}
      try{ if(navigator.vibrate) navigator.vibrate(50); }catch(e){}
    }

    // ===== overlay recusa =====
    function abrirOverlayRecusa(mensagem) {
      const ov = document.getElementById('recusaOverlay');
      const tx = document.getElementById('recusaTexto');
      tx.textContent = (mensagem || '').toString().trim();
      ov.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function fecharOverlayRecusa() {
      const ov = document.getElementById('recusaOverlay');
      ov.style.display = 'none';
      document.body.style.overflow = '';
    }

    // ===== estado / storage =====
    const LS_FILIAL = "hs_nf_filial";
    function keyHist(filial){ return `hs_nf_hist_${filial}`; }

    let filialAtual = "";

    // ===== refs =====
    const elLogin = document.getElementById("login-nf");
    const elPrincipal = document.getElementById("principal-nf");

    const inpCodigo = document.getElementById("codigo-nf");
    const btnEntrar = document.getElementById("btn-entrar-nf");
    const btnSair = document.getElementById("btn-sair-nf");

    const inpChave = document.getElementById("chave-nf");
    const btnLeitor = document.getElementById("btn-leitor-nf");
    const btnConsultar = document.getElementById("btn-consultar-nf");

    const elScanner = document.getElementById("scanner");
    const elScannerView = document.getElementById("scanner-view");

    const elLoading = document.getElementById("loading-nf");
    const elResultado = document.getElementById("resultado-nf");
    const elErro1 = document.getElementById("erro-nf");
    const elErro2 = document.getElementById("erro-nf2");

    const elHistLista = document.getElementById("historicoLista-nf");
    const btnLimparHist = document.getElementById("btn-limpar-nf");

    // ===== scanner Html5Qrcode =====
    let html5 = null;
    let scannerAtivo = false;
    let travadoLeitura = false;
    let ultimoHash = "";

    async function iniciarScanner(){
      elErro2.textContent = "";
      if(scannerAtivo) return;

      elScanner.style.display = "block";
      elScannerView.innerHTML = `<div id="html5-nf44" style="width:100%"></div>`;

      travadoLeitura = false;
      ultimoHash = "";

      if(html5){
        try{ await html5.stop(); }catch(e){}
        try{ await html5.clear(); }catch(e){}
        html5 = null;
      }

      html5 = new Html5Qrcode("html5-nf44");
      const config = {
        fps: 14,
        qrbox: { width: 320, height: 220 },
        experimentalFeatures: { useBarCodeDetectorIfSupported: true },
        rememberLastUsedCamera: true
      };

      scannerAtivo = true;

      try{
        await html5.start(
          { facingMode: "environment" },
          config,
          async (decodedText) => {
            if(travadoLeitura) return;

            const chave = extrairChave44(decodedText);
            if(!chave) return;

            // anti-repeti√ß√£o
            const now = Date.now();
            const hash = chave + ":" + Math.floor(now/800);
            if(hash === ultimoHash) return;
            ultimoHash = hash;

            travadoLeitura = true;
            inpChave.value = chave;
            beepOk();

            // fecha autom√°tico
            await new Promise(r => setTimeout(r, 120));
            await pararScanner();
          },
          () => {}
        );
      }catch(err){
        scannerAtivo = false;
        elScanner.style.display = "none";
        elErro2.textContent = "N√£o consegui iniciar a c√¢mera. Verifique permiss√£o da c√¢mera no navegador.";
      }
    }

    async function pararScanner(){
      try{
        if(html5){
          await html5.stop().catch(()=>{});
          await html5.clear().catch(()=>{});
          html5 = null;
        }
      }catch(e){}
      scannerAtivo = false;
      elScanner.style.display = "none";
    }

    // ===== hist√≥rico =====
    function loadHistorico(){
      try{
        const raw = localStorage.getItem(keyHist(filialAtual));
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }

    function saveHistorico(arr){
      try{ localStorage.setItem(keyHist(filialAtual), JSON.stringify(arr || [])); }catch(e){}
    }

    function renderHistorico(){
      const arr = loadHistorico();
      elHistLista.innerHTML = "";
      arr.forEach(ch => {
        const li = document.createElement("li");
        li.textContent = ch;
        li.title = "Clique para usar esta chave";
        li.addEventListener("click", () => {
          inpChave.value = ch;
          inpChave.focus();
        });
        elHistLista.appendChild(li);
      });
    }

    function addHistorico(chave){
      const c = onlyDigits(chave);
      if(c.length !== 44) return;
      let arr = loadHistorico();
      arr = arr.filter(x => x !== c);
      arr.unshift(c);
      if(arr.length > 30) arr = arr.slice(0, 30);
      saveHistorico(arr);
      renderHistorico();
    }

    // ===== login =====
    function entrar(){
      elErro1.textContent = "";
      const cod = onlyDigits(inpCodigo.value);
      if(!cod){
        elErro1.textContent = "Digite o c√≥digo da sua filial.";
        return;
      }
      filialAtual = cod;
      localStorage.setItem(LS_FILIAL, filialAtual);
      setHidden(elLogin, true);
      setHidden(elPrincipal, false);
      renderHistorico();
    }

    function sair(){
      if(!confirm("Deseja sair?")) return;
      localStorage.removeItem(LS_FILIAL);
      location.reload();
    }

    // ===== API =====
    async function apiGet(params){
      const qs = new URLSearchParams();
      Object.keys(params||{}).forEach(k => qs.set(k, params[k]));
      const url = `${URL_API}?${qs.toString()}&t=${Date.now()}`;
      const resp = await fetch(url);
      return await resp.json();
    }

    // ===== consulta =====
    async function consultar(){
      elErro2.textContent = "";
      setHidden(elResultado, true);

      const chave = onlyDigits(inpChave.value);
      if(chave.length !== 44){
        elErro2.textContent = "A chave deve ter 44 d√≠gitos.";
        return;
      }
      if(!URL_API || URL_API.includes("https://script.google.com/macros/s/AKfycbxu_jVaotWytMOQh4UCZetFZFOxgk5ePrOkaviDd-qKNPiu2_8BjCaNczAVZzaDwAbj/exec")){
        elErro2.textContent = "Falta configurar o AppWeb (URL_API) aqui no nf.html.";
        return;
      }

      setHidden(elLoading, false);

      try{
        const data = await apiGet({ api: API_CONSULTA, filial: filialAtual, chave });

        // overlay recusa (se backend retornar)
        if(data && (data.motivoRecusa || data.recusa === true)){
          abrirOverlayRecusa(data.mensagemRecusa || data.mensagem || "Nota marcada para recusa.");
        }

        if(data && data.success === false){
          throw new Error(data.message || "Erro ao consultar.");
        }

        // render resultado (ajusta conforme teu retorno)
        const numero = data.numeroNF ?? data.numero ?? "‚Äî";
        const emit = data.emitente ?? data.nomeEmitente ?? "‚Äî";
        const qtd = data.quantidadeTotal ?? data.qtdTotal ?? "‚Äî";
        const valor = data.valorTotal ?? data.vNF ?? "‚Äî";

        elResultado.innerHTML = `
          <div style="line-height:1.7">
            <b>N√∫mero NF:</b> ${numero}<br/>
            <b>Emitente:</b> ${emit}<br/>
            <b>Quantidade total:</b> ${qtd}<br/>
            <b>Valor total:</b> ${valor}
          </div>
        `;
        setHidden(elResultado, false);

        addHistorico(chave);

      }catch(err){
        elErro2.textContent = (err && err.message) ? err.message : "Erro ao consultar.";
      }finally{
        setHidden(elLoading, true);
      }
    }

    // ===== binds =====
    document.addEventListener('DOMContentLoaded', () => {
      // overlay recusa binds
      const btnFechar = document.getElementById('btn-fechar-recusa');
      const ov = document.getElementById('recusaOverlay');
      btnFechar.addEventListener('click', fecharOverlayRecusa);
      ov.addEventListener('click', (e) => { if (e.target === ov) fecharOverlayRecusa(); });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && ov.style.display === 'flex') fecharOverlayRecusa();
      });

      // restaura filial
      const saved = localStorage.getItem(LS_FILIAL);
      if(saved){
        filialAtual = saved;
        setHidden(elLogin, true);
        setHidden(elPrincipal, false);
        renderHistorico();
      }else{
        setHidden(elLogin, false);
        setHidden(elPrincipal, true);
      }

      btnEntrar.addEventListener("click", entrar);
      btnSair.addEventListener("click", sair);

      btnLeitor.addEventListener("click", async () => {
        if(scannerAtivo) await pararScanner();
        else await iniciarScanner();
      });

      btnConsultar.addEventListener("click", consultar);

      btnLimparHist.addEventListener("click", () => {
        if(!confirm("Limpar hist√≥rico local desta filial?")) return;
        saveHistorico([]);
        renderHistorico();
      });

      inpChave.addEventListener("keydown", (e) => {
        if(e.key === "Enter"){
          e.preventDefault();
          consultar();
        }
      });
    });
  </script>

</body>
</html>
