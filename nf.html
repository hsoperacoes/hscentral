<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GERENCIAL HS - Recebimento de Nota Fiscal</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- ‚úÖ NOVO LEITOR (substitui Dynamsoft) -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background-color: #000;
      color: #fff;
      margin: 0; padding: 0;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }

    /* BOT√ÉO HOME PADR√ÉO PRETO */
    .back-button {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #020617;
      color: #e5e7eb;
      border: 1px solid #111827;
      padding: 10px 22px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 14px;
      z-index: 2000;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }
    .back-button i { margin-right: 6px; }
    .back-button:hover {
      background-color: #111827;
      transform: translateX(-50%) translateY(-1px);
    }

    .logo-topo {
      width: 100px;
      height: auto;
      margin: 90px 0 10px;
    }

    .form-container {
      max-width: 600px; width: 95%;
      background: #1e1e1e; padding: 30px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.3); color: #fff; margin: 20px auto;
    }

    .form-container h2 { text-align: center; color: #fff; margin-bottom: 20px; }

    input, button {
      width: 100%; padding: 12px; font-size: 14px;
      border: 1px solid #444; border-radius: 4px;
      background-color: #2a2a2a; color: #fff;
    }

    button { border: none; background-color: #673ab7; cursor: pointer; font-weight: 600; margin-top: 10px; }
    button:hover { background-color: #5e35b1; }

    .hidden { display: none; }

    .logout { text-align: right; margin-bottom: 10px; }
    .logout button {
      background-color: #5f6368;
      width: auto;
      padding: 8px 16px;
      margin-top: 0;
    }

    .result { background: #111; border: 1px solid #333; padding: 12px; border-radius: 6px; }

    .history {
      margin-top: 20px;
      background: #141414;
      padding: 10px;
      border-radius: 8px;
    }

    .history ul { list-style: none; padding: 0; margin: 0; }
    .history li { padding: 6px 8px; border-bottom: 1px solid #222; cursor: pointer; }
    .history li:hover { background: #1d1d1d; }

    /* ‚úÖ mant√©m o MESMO container e tamanho do scanner */
    #scanner {
      width: 100%; max-width: 420px; height: 280px;
      margin: 10px auto; position: relative; display: none;
      justify-content: center; align-items: center; background: #111;
      border: 1px solid #333; border-radius: 8px;
      overflow: hidden;
    }

    /* √°rea interna do html5-qrcode */
    #html5-reader{
      width: 100%;
      height: 100%;
    }
    #html5-reader video, #html5-reader canvas{
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
    }

    /* bot√£o fechar scanner (opcional, discreto) */
    .scanner-close {
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 10;
      background: rgba(2,6,23,.85);
      border: 1px solid #111827;
      color: #e5e7eb;
      width: auto;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      margin-top: 0;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .scanner-close:hover{ background: rgba(17,24,39,.9); }

    footer {
      text-align:center; font-size:14px; color:#ccc;
      background:#2c2c2c; padding:15px;
      border-radius:6px; margin: 20px auto;
      max-width: 900px; width: 100%;
    }

    /* ===================== OVERLAY RECUSA ===================== */
    #recusaOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.88);
      z-index: 99999;
      align-items: center;
      justify-content: center;
      padding: 18px;
      backdrop-filter: blur(2px);
    }

    .recusa-card {
      width: 100%;
      max-width: 880px;
      border: 1px solid #2a2a2f;
      border-radius: 18px;
      background: #0b0b0c;
      box-shadow: 0 8px 30px rgba(0,0,0,.55);
      overflow: hidden;
    }

    .recusa-topo {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 16px;
      border-bottom: 1px solid #2a2a2f;
      background: linear-gradient(180deg, #141416, #0f0f12);
    }

    .recusa-titulo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 900;
      color: #ff3b3b;
      letter-spacing: .2px;
    }

    .recusa-btn-fechar {
      border: 1px solid #2a2a2f;
      background: transparent;
      color: #fff;
      border-radius: 12px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 800;
      width: auto;
      margin-top: 0;
    }
    .recusa-btn-fechar:hover {
      background: rgba(255,255,255,.06);
    }

    .recusa-conteudo { padding: 16px; background: #0b0b0c; }

    .recusa-texto {
      white-space: pre-wrap;
      font-size: 16px;
      line-height: 1.55;
      color: #fff;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid #2a2a2f;
      background: #101012;
    }

    .recusa-rodape {
      padding: 14px 16px;
      border-top: 1px solid #2a2a2f;
      color: #b9b9c2;
      font-size: 13px;
      background: #0f0f12;
    }
  </style>
</head>

<body>

  <a href="index.html" class="back-button">
    <i class="fas fa-arrow-left"></i> Voltar √† Home
  </a>

  <img src="logo.png" alt="Logo HS" class="logo-topo" />

  <div class="form-container">

    <!-- LOGIN FILIAL -->
    <div id="login-nf">
      <h2>Login da Filial</h2>
      <label for="codigo-nf">C√≥digo da Filial</label>
      <input type="text" id="codigo-nf" placeholder="Digite o c√≥digo da sua filial" />
      <button id="btn-entrar-nf">Entrar</button>
      <div id="erro-nf" style="color:#ff6b6b;margin-top:8px;"></div>
    </div>

    <!-- TELA PRINCIPAL -->
    <div id="principal-nf" class="hidden">
      <div class="logout">
        <button id="btn-sair-nf">Sair</button>
      </div>

      <h2>Consulta de Nota Fiscal</h2>

      <label for="chave-nf">Chave de Acesso (44 d√≠gitos)</label>
      <input type="text" id="chave-nf" placeholder="Digite a chave completa" maxlength="44" />

      <button id="btn-leitor-nf">üì∑ Ler C√≥digo de Barras</button>

      <!-- ‚úÖ scanner mant√©m o mesmo bloco -->
      <div id="scanner">
        <button class="scanner-close" id="btn-fechar-scanner">
          <i class="fas fa-times"></i> Fechar
        </button>
        <div id="html5-reader"></div>
      </div>

      <button id="btn-consultar-nf">Consultar</button>
      <div id="loading-nf" class="hidden">‚è≥ Consultando nota fiscal...</div>
      <div id="resultado-nf" class="result hidden"></div>
      <div id="erro-nf2" style="color: #ff6b6b; margin-top: 8px;"></div>

      <div class="history">
        <h3>Hist√≥rico da Filial</h3>
        <ul id="historicoLista-nf"></ul>
        <button id="btn-limpar-nf">üóë Limpar Hist√≥rico Local</button>
      </div>
    </div>
  </div>

  <footer>HS Opera√ß√µes ¬© 2025 - Todos os direitos reservados</footer>

  <!-- OVERLAY RECUSA -->
  <div id="recusaOverlay">
    <div class="recusa-card" role="dialog" aria-modal="true">
      <div class="recusa-topo">
        <div class="recusa-titulo">üö´ NOTA MARCADA PARA RECUSA</div>
        <button class="recusa-btn-fechar" id="btn-fechar-recusa">Fechar</button>
      </div>

      <div class="recusa-conteudo">
        <div class="recusa-texto" id="recusaTexto"></div>
      </div>

      <div class="recusa-rodape">
        Se houver confirma√ß√£o da recusa, realize tamb√©m a recusa no controle de transporte e na via f√≠sica destinada ao escrit√≥rio.
      </div>
    </div>
  </div>

  <script>
    /***************************************************
      ‚úÖ SEU APPWEB (global) ‚Äî fica dispon√≠vel pro script_nf.js
    ***************************************************/
    window.URL_API = "https://script.google.com/macros/s/AKfycbxu_jVaotWytMOQh4UCZetFZFOxgk5ePrOkaviDd-qKNPiu2_8BjCaNczAVZzaDwAbj/exec";

    function abrirOverlayRecusa(mensagem) {
      const ov = document.getElementById('recusaOverlay');
      const tx = document.getElementById('recusaTexto');
      tx.textContent = (mensagem || '').toString().trim();
      ov.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function fecharOverlayRecusa() {
      const ov = document.getElementById('recusaOverlay');
      ov.style.display = 'none';
      document.body.style.overflow = '';
    }

    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('btn-fechar-recusa');
      const ov = document.getElementById('recusaOverlay');

      btn.addEventListener('click', fecharOverlayRecusa);
      ov.addEventListener('click', (e) => { if (e.target === ov) fecharOverlayRecusa(); });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && ov.style.display === 'flex') fecharOverlayRecusa();
      });
    });
  </script>

  <!-- ‚úÖ LEITOR NOVO (inline) ‚Äî sem script separado pro scanner -->
  <script>
    let html5ScannerNF = null;
    let scannerAberto = false;
    let travadoNF = false;

    function extrairChave44(texto){
      const only = String(texto || "").replace(/\D/g, "");
      if (only.length < 44) return "";
      for (let i=0; i<=only.length-44; i++){
        const cand = only.slice(i, i+44);
        if (/^\d{44}$/.test(cand)) return cand;
      }
      return "";
    }

    function beepOk(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "square";
        o.frequency.value = 880;
        g.gain.value = 0.10;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        setTimeout(()=>o.stop(), 120);
      }catch(e){}
      try{ if(navigator.vibrate) navigator.vibrate(60); }catch(e){}
    }

    async function abrirScannerNF(){
      const box = document.getElementById("scanner");
      const readerId = "html5-reader";

      box.style.display = "flex";
      scannerAberto = true;
      travadoNF = false;

      // garante limpa (caso tenha algo preso)
      await fecharScannerNF(true);

      html5ScannerNF = new Html5Qrcode(readerId);

      // config mais forte pra c√≥digo de barras (melhora leitura)
      const config = {
        fps: 18,
        qrbox: { width: 360, height: 180 },
        aspectRatio: 1.777,
        experimentalFeatures: { useBarCodeDetectorIfSupported: true },
        rememberLastUsedCamera: true
      };

      await html5ScannerNF.start(
        { facingMode: "environment" },
        config,
        async (decodedText) => {
          if(!scannerAberto) return;
          if(travadoNF) return;

          const chave = extrairChave44(decodedText);
          if(!chave) return;

          travadoNF = true;
          document.getElementById("chave-nf").value = chave;

          beepOk();
          await new Promise(r => setTimeout(r, 120));
          await fecharScannerNF();
        },
        () => {}
      );
    }

    async function fecharScannerNF(silencioso){
      const box = document.getElementById("scanner");
      if(!silencioso){
        box.style.display = "none";
        scannerAberto = false;
      }

      try{
        if(html5ScannerNF){
          await html5ScannerNF.stop().catch(()=>{});
          await html5ScannerNF.clear().catch(()=>{});
          html5ScannerNF = null;
        }
      }catch(e){}
    }

    async function toggleScannerNF(){
      if(scannerAberto){
        await fecharScannerNF();
      }else{
        await abrirScannerNF();
      }
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      const btnLeitor = document.getElementById("btn-leitor-nf");
      const btnFechar = document.getElementById("btn-fechar-scanner");

      if(btnLeitor) btnLeitor.addEventListener("click", toggleScannerNF);
      if(btnFechar) btnFechar.addEventListener("click", async (e)=>{ e.preventDefault(); await fecharScannerNF(); });

      // fecha no ESC se estiver aberto
      document.addEventListener("keydown", async (e)=>{
        if(e.key === "Escape" && scannerAberto){
          await fecharScannerNF();
        }
      });
    });
  </script>

  <!-- ‚úÖ seu JS original continua intacto (login/consulta/hist√≥rico/recusa) -->
  <script src="script_nf.js?v=1.0.4"></script>

</body>
</html>
